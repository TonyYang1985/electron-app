name: åº”ç”¨æ„å»º

on:
  workflow_call:
    inputs:
      ref:
        required: true
        type: string
      event_name:
        required: true
        type: string
      github_ref:
        required: true
        type: string
      input_environment:
        required: true
        type: string
      input_version:
        required: true
        type: string
      run_number:
        required: true
        type: string
    outputs:
      build_environment:
        description: "æ„å»ºç¯å¢ƒ"
        value: ${{ jobs.build.outputs.build_environment }}

jobs:
  build:
    name: æ„å»º ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            name: Windows
            platform: win
          - os: macos-latest
            name: macOS
            platform: mac
          - os: ubuntu-latest
            name: Linux
            platform: linux

    outputs:
      build_environment: ${{ steps.parse_env.outputs.BUILD_ENVIRONMENT }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: æ˜¾ç¤ºå½“å‰ç›®å½• (Build Job)
        run: |
          echo "â¡ï¸ Current directory (build job start):"
          pwd

      - name: è§£æç¯å¢ƒä¿¡æ¯
        id: parse_env
        shell: bash
        run: |
          # ä»git tagæˆ–æ‰‹åŠ¨è¾“å…¥è§£æç¯å¢ƒ
          if [[ "${{ inputs.event_name }}" == "push" && "${{ inputs.github_ref }}" == refs/tags/* ]]; then
            # ä»æ ‡ç­¾è§£æç¯å¢ƒ (æ”¯æŒå¿½ç•¥å¤§å°å†™)
            TAG_NAME="${{ inputs.github_ref }}"
            TAG_NAME=${TAG_NAME#refs/tags/}
            echo "ğŸ“‹ æ£€æµ‹åˆ°æ ‡ç­¾: $TAG_NAME"
            
            # æå–ç¯å¢ƒåç¼€å¹¶è½¬æ¢ä¸ºå¤§å†™
            if [[ $TAG_NAME =~ -([a-zA-Z]+)$ ]]; then
              ENV_SUFFIX="${BASH_REMATCH[1]}"
              ENV_SUFFIX=$(echo "$ENV_SUFFIX" | tr '[:lower:]' '[:upper:]')
              echo "ğŸ¯ æ£€æµ‹åˆ°ç¯å¢ƒåç¼€: $ENV_SUFFIX"
              
              case $ENV_SUFFIX in
                "DEV"|"DEVELOPMENT")
                  BUILD_ENV="DEV"
                  ;;
                "SIT"|"STAGING")
                  BUILD_ENV="SIT"
                  ;;
                "DEMO"|"DEMONSTRATION")
                  BUILD_ENV="DEMO"
                  ;;
                "PROD"|"PRODUCTION")
                  BUILD_ENV="PROD"
                  ;;
                *)
                  echo "âš ï¸ æœªè¯†åˆ«çš„ç¯å¢ƒåç¼€: $ENV_SUFFIXï¼Œé»˜è®¤ä½¿ç”¨ PROD"
                  BUILD_ENV="PROD"
                  ;;
              esac
            else
              echo "ğŸ“¦ æ— ç¯å¢ƒåç¼€ï¼Œé»˜è®¤ä½¿ç”¨ PROD"
              BUILD_ENV="PROD"
            fi
          else
            # æ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨è¾“å…¥çš„ç¯å¢ƒ
            BUILD_ENV="${{ inputs.input_environment }}"
          fi

          echo "ğŸš€ æ„å»ºç¯å¢ƒ: $BUILD_ENV"
          echo "BUILD_ENVIRONMENT=$BUILD_ENV" >> $GITHUB_OUTPUT
          echo "BUILD_ENVIRONMENT=$BUILD_ENV" >> $GITHUB_ENV

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      # ä½¿ç”¨å¤åˆåŠ¨ä½œå¤„ç†macOSæ„å»º
      - name: macOSæ„å»ºå¤„ç†
        if: matrix.os == 'macos-latest'
        uses: ./.github/actions/macos-build
        with:
          platform: ${{ matrix.platform }}
          environment: ${{ steps.parse_env.outputs.BUILD_ENVIRONMENT }}

      # ä½¿ç”¨å¤åˆåŠ¨ä½œå¤„ç†é€šç”¨æ„å»º
      - name: é€šç”¨æ„å»ºå¤„ç†
        if: matrix.os != 'macos-latest'
        uses: ./.github/actions/generic-build
        with:
          platform: ${{ matrix.platform }}
          environment: ${{ steps.parse_env.outputs.BUILD_ENVIRONMENT }}

      # éªŒè¯æ„å»ºç»“æœ - ä½¿ç”¨ç›®æ ‡ç¯å¢ƒ
      - name: éªŒè¯æ„å»ºç»“æœ
        shell: bash
        run: |
          echo "=== ${{ matrix.name }} æ„å»ºéªŒè¯ (ç¯å¢ƒ: ${{ steps.parse_env.outputs.BUILD_ENVIRONMENT }}) ==="

          # åªæ£€æŸ¥ç›®æ ‡ç¯å¢ƒç›®å½•
          TARGET_ENV="${{ steps.parse_env.outputs.BUILD_ENVIRONMENT }}"
          BUILD_DIR="BMO-MO-APP-RELEASES/$TARGET_ENV"

          if [ -d "$BUILD_DIR" ]; then
            echo "ğŸ“ æ‰¾åˆ°æ„å»ºç›®å½•: $BUILD_DIR"
            
            # æŸ¥æ‰¾æ„å»ºæ–‡ä»¶
            BUILD_FILES=$(find "$BUILD_DIR" -name "*.exe" -o -name "*.dmg" -o -name "*.zip" -o -name "*.deb" -o -name "*.rpm" -o -name "*.AppImage" 2>/dev/null || true)
            
            if [ -n "$BUILD_FILES" ]; then
              echo "âœ… æ‰¾åˆ°æ„å»ºæ–‡ä»¶:"
              echo "$BUILD_FILES" | while read -r file; do
                [ -n "$file" ] && ls -lh "$file"
              done
              
              FILE_COUNT=$(echo "$BUILD_FILES" | grep -c . || echo 0)
              echo "ğŸ“Š æ„å»ºç»Ÿè®¡: æ‰¾åˆ° $FILE_COUNT ä¸ªæ„å»ºæ–‡ä»¶"
              echo "âœ… ${{ matrix.name }} æ„å»ºæˆåŠŸ"
            else
              echo "âŒ ${{ matrix.name }} æ„å»ºå¤±è´¥: ç›®å½•å­˜åœ¨ä½†æœªæ‰¾åˆ°æ„å»ºæ–‡ä»¶"
              
              # æ˜¾ç¤ºç›®å½•å†…å®¹å¸®åŠ©è°ƒè¯•
              echo "ğŸ” è°ƒè¯•ä¿¡æ¯ - ç›®å½•å†…å®¹:"
              find "$BUILD_DIR" -type f | head -20
              exit 1
            fi
          else
            echo "âŒ ${{ matrix.name }} æ„å»ºå¤±è´¥: æœªæ‰¾åˆ°ç›®æ ‡ç¯å¢ƒç›®å½• $BUILD_DIR"
            echo "å½“å‰ç›®å½•ç»“æ„:"
            find . -maxdepth 2 -type d | head -10
            exit 1
          fi

      # ä¸Šä¼ æ„å»ºäº§ç‰© - åªä¸Šä¼ ç›®æ ‡ç¯å¢ƒ
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-${{ steps.parse_env.outputs.BUILD_ENVIRONMENT }}-v${{ inputs.run_number }}
          path: |
            BMO-MO-APP-RELEASES/${{ steps.parse_env.outputs.BUILD_ENVIRONMENT }}/*
          retention-days: 7
          compression-level: 6
          if-no-files-found: warn