name: æ„å»ºå’Œå‘å¸ƒ

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.15)'
        required: true
        default: '1.0.15'

permissions:
  contents: write

jobs:
  # æ„å»ºé˜¶æ®µ - å®Œå…¨ç¦ç”¨è‡ªåŠ¨å‘å¸ƒ
  build:
    name: æ„å»º ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            name: Windows
            platform: win
          - os: macos-latest
            name: macOS
            platform: mac
          - os: ubuntu-latest
            name: Linux
            platform: linux
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          # ä½¿ç”¨ç‰¹å®šSHAé¿å…æ ‡ç­¾ä¿¡æ¯
          ref: ${{ github.sha }}
      
      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      
      - name: å®‰è£…ä¾èµ–
        run: npm ci
      
      # ç¼–è¯‘ TypeScript ä»£ç 
      - name: ç¼–è¯‘å’Œå‡†å¤‡æ–‡ä»¶
        run: npm run build
        
      # éªŒè¯ç¼–è¯‘ç»“æœ
      - name: éªŒè¯ç¼–è¯‘ç»“æœ
        shell: bash
        run: |
          echo "=== TypeScript ç¼–è¯‘éªŒè¯ ==="
          if [ -f "release/main.js" ]; then
            echo "âœ… main.js ç¼–è¯‘æˆåŠŸ"
            ls -la release/
          else
            echo "âŒ TypeScript ç¼–è¯‘å¤±è´¥: main.js ä¸å­˜åœ¨"
            exit 1
          fi
          
          if [ -f "release/index.html" ]; then
            echo "âœ… index.html å¤åˆ¶æˆåŠŸ"
          else
            echo "âŒ èµ„æºå¤åˆ¶å¤±è´¥: index.html ä¸å­˜åœ¨"
            exit 1
          fi
      
      # å½»åº•æ¸…ç†Gitç¯å¢ƒé˜²æ­¢electron-builderæ£€æµ‹æ ‡ç­¾
      - name: æ¸…ç†Gitæ ‡ç­¾ç¯å¢ƒ
        shell: bash
        run: |
          echo "æ¸…ç†Gitç¯å¢ƒä»¥é˜²æ­¢electron-builderè‡ªåŠ¨å‘å¸ƒ..."
          
          # ç§»é™¤æ‰€æœ‰è¿œç¨‹å¼•ç”¨
          git remote remove origin || true
          
          # åˆ é™¤æ‰€æœ‰æ ‡ç­¾
          git tag -l | xargs -r git tag -d
          
          # é‡æ–°åˆå§‹åŒ–ä¸ºæ™®é€šä»“åº“
          rm -rf .git/refs/remotes
          rm -rf .git/refs/tags
          
          # éªŒè¯æ¸…ç†ç»“æœ
          echo "å½“å‰GitçŠ¶æ€:"
          git status || echo "GitçŠ¶æ€æ£€æŸ¥å®Œæˆ"
          git tag -l || echo "æ— æ ‡ç­¾"
          
          echo "âœ… Gitç¯å¢ƒå·²æ¸…ç†ï¼Œelectron-builderä¸ä¼šæ£€æµ‹åˆ°å‘å¸ƒæ¡ä»¶"
      
      # æ„å»º
      - name: æ„å»º ${{ matrix.name }}
        run: npm run build:${{ matrix.platform }}
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # éªŒè¯æ„å»ºç»“æœ
      - name: éªŒè¯æ„å»ºç»“æœ
        shell: bash
        run: |
          echo "=== ${{ matrix.name }} æ„å»ºéªŒè¯ ==="
          if [ -d "dist" ]; then
            echo "ğŸ“ æ„å»ºæ–‡ä»¶:"
            find dist/ -type f \( \
              -name "*.exe" -o \
              -name "*.dmg" -o \
              -name "*.zip" -o \
              -name "*.deb" -o \
              -name "*.rpm" -o \
              -name "*.AppImage" -o \
              -name "*.yml" -o \
              -name "*.blockmap" \
            \) -exec ls -lh {} \;
            
            file_count=$(find dist/ -type f \( -name "*.exe" -o -name "*.dmg" -o -name "*.zip" -o -name "*.deb" -o -name "*.rpm" -o -name "*.AppImage" \) | wc -l)
            echo ""
            echo "ğŸ“Š æ„å»ºç»Ÿè®¡: æ‰¾åˆ° $file_count ä¸ªä¸»è¦æ–‡ä»¶"
            
            if [ $file_count -gt 0 ]; then
              echo "âœ… ${{ matrix.name }} æ„å»ºæˆåŠŸ"
            else
              echo "âŒ ${{ matrix.name }} æ„å»ºå¤±è´¥: æœªæ‰¾åˆ°é¢„æœŸæ–‡ä»¶"
              exit 1
            fi
          else
            echo "âŒ ${{ matrix.name }} æ„å»ºå¤±è´¥: distç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
      
      # ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-v${{ github.run_number }}
          path: |
            dist/*.exe
            dist/*.dmg
            dist/*.zip
            dist/*.deb
            dist/*.rpm
            dist/*.AppImage
            dist/*.yml
            dist/*.blockmap
          retention-days: 7
          compression-level: 6
          if-no-files-found: warn

  # å‘å¸ƒé˜¶æ®µ
  release:
    name: åˆ›å»ºGitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: needs.build.result == 'success'
    timeout-minutes: 30
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="${{ github.event.inputs.version || '1.0.15' }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ å‘å¸ƒç‰ˆæœ¬: $VERSION"
      
      # ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
      
      # æ•´ç†å‘å¸ƒæ–‡ä»¶
      - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
        run: |
          mkdir -p release-files
          
          echo "=== æ£€æŸ¥ä¸‹è½½çš„æ„å»ºäº§ç‰© ==="
          find artifacts/ -type f \( \
            -name "*.exe" -o \
            -name "*.dmg" -o \
            -name "*.zip" -o \
            -name "*.deb" -o \
            -name "*.rpm" -o \
            -name "*.AppImage" -o \
            -name "*.yml" -o \
            -name "*.blockmap" \
          \) -exec ls -lh {} \;
          
          # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶åˆ°releaseç›®å½•
          find artifacts/ -type f \( \
            -name "*.exe" -o \
            -name "*.dmg" -o \
            -name "*.zip" -o \
            -name "*.deb" -o \
            -name "*.rpm" -o \
            -name "*.AppImage" -o \
            -name "*.yml" -o \
            -name "*.blockmap" \
          \) -exec cp {} release-files/ \;
          
          echo ""
          echo "=== å‡†å¤‡å‘å¸ƒçš„æ–‡ä»¶ ==="
          ls -lah release-files/
          
          # ç»Ÿè®¡æ–‡ä»¶ä¿¡æ¯
          file_count=$(ls -1 release-files/ | wc -l)
          total_size=$(du -sh release-files/ | cut -f1)
          
          echo ""
          echo "ğŸ“Š å‘å¸ƒç»Ÿè®¡:"
          echo "  ğŸ“ æ–‡ä»¶æ•°é‡: $file_count"
          echo "  ğŸ’¾ æ€»å¤§å°: $total_size"
          
          # åˆ†ç±»ç»Ÿè®¡
          windows_count=$(ls -1 release-files/*.exe 2>/dev/null | wc -l || echo 0)
          macos_count=$(ls -1 release-files/*.dmg 2>/dev/null | wc -l || echo 0)
          linux_count=$(ls -1 release-files/*.AppImage 2>/dev/null | wc -l || echo 0)
          
          echo "  ğŸªŸ Windowsæ–‡ä»¶: $windows_count"
          echo "  ğŸ macOSæ–‡ä»¶: $macos_count"
          echo "  ğŸ§ Linuxæ–‡ä»¶: $linux_count"
          
          if [ $file_count -eq 0 ]; then
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°å¯å‘å¸ƒçš„æ–‡ä»¶"
            exit 1
          fi
      
      # ç”ŸæˆReleaseè¯´æ˜
      - name: ç”ŸæˆReleaseè¯´æ˜
        run: |
          cat > release_notes.md << 'EOF'
          ## ğŸš€ My Awesome App v${{ steps.version.outputs.version }}
          
          ### ğŸ“¦ æ”¯æŒå¹³å°
          
          **ğŸªŸ Windows (x64)**
          - NSISå®‰è£…ç¨‹åº (æ¨è) - åŒå‡»å®‰è£…ï¼Œæ”¯æŒè‡ªåŠ¨æ›´æ–°
          - ä¾¿æºç‰ˆæœ¬ - ç»¿è‰²ç‰ˆï¼Œæ— éœ€å®‰è£…
          
          **ğŸ macOS**
          - Intel Mac (x64) - æ”¯æŒmacOS 10.12+
          - Apple Silicon (ARM64) - åŸç”ŸMç³»åˆ—èŠ¯ç‰‡æ”¯æŒ
          
          **ğŸ§ Linux (x64)**
          - AppImage - é€šç”¨ä¾¿æºç‰ˆæœ¬ï¼Œé€‚ç”¨äºæ‰€æœ‰å‘è¡Œç‰ˆ
          - Debian/Ubuntu (.deb) - ç³»ç»ŸåŒ…ç®¡ç†å™¨å®‰è£…
          - CentOS/Fedora (.rpm) - ç³»ç»ŸåŒ…ç®¡ç†å™¨å®‰è£…
          
          ### ğŸ“ å®‰è£…æŒ‡å—
          
          **Windows:**
          1. ä¸‹è½½ `My-Awesome-App-*-win-x64.exe` (NSISå®‰è£…ç¨‹åº)
          2. åŒå‡»è¿è¡Œï¼ŒæŒ‰å‘å¯¼å®‰è£…
          3. å¦‚é‡å®‰å…¨æç¤ºï¼Œç‚¹å‡»"æ›´å¤šä¿¡æ¯" â†’ "ä»è¦è¿è¡Œ"
          
          **macOS:**
          1. æ ¹æ®èŠ¯ç‰‡ç±»å‹ä¸‹è½½å¯¹åº”çš„ `.dmg` æ–‡ä»¶
          2. åŒå‡»æŒ‚è½½ï¼Œæ‹–æ‹½åº”ç”¨åˆ° Applications æ–‡ä»¶å¤¹
          3. é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦å³é”®ç‚¹å‡» â†’ "æ‰“å¼€"
          
          **Linux:**
          1. **AppImage (æ¨è)**: ä¸‹è½½åæ·»åŠ æ‰§è¡Œæƒé™ `chmod +x *.AppImage`
          2. **Ubuntu/Debian**: `sudo dpkg -i *.deb`
          3. **CentOS/Fedora**: `sudo rpm -i *.rpm`
          
          ### ğŸ”„ è‡ªåŠ¨æ›´æ–°
          
          âœ… åº”ç”¨å†…ç½®è‡ªåŠ¨æ›´æ–°åŠŸèƒ½  
          âœ… å®‰è£…åä¼šè‡ªåŠ¨æ£€æµ‹æ–°ç‰ˆæœ¬  
          âœ… æ”¯æŒå¢é‡æ›´æ–°ï¼ŒèŠ‚çœä¸‹è½½æ—¶é—´  
          
          ### ğŸ› ï¸ æŠ€æœ¯ä¿¡æ¯
          
          - **Electron**: 28.3.3
          - **Node.js**: 18.x  
          - **æ„å»ºå¹³å°**: GitHub Actions
          - **æ„å»ºæ—¶é—´**: $(date)
          
          ### ğŸ” æ–‡ä»¶æ ¡éªŒ
          
          æ‰€æœ‰æ–‡ä»¶éƒ½åŒ…å«SHAæ ¡éªŒå€¼ (.blockmapæ–‡ä»¶)ï¼Œç¡®ä¿ä¸‹è½½å®Œæ•´æ€§ã€‚
          
          ---
          
          **ğŸ”— ç›¸å…³é“¾æ¥**
          - [ğŸ“– æºä»£ç ](https://github.com/${{ github.repository }})
          - [ğŸ› é—®é¢˜åé¦ˆ](https://github.com/${{ github.repository }}/issues)
          - [ğŸ“ æ›´æ–°æ—¥å¿—](https://github.com/${{ github.repository }}/releases)
          - [ğŸ“š ä½¿ç”¨æ–‡æ¡£](https://github.com/${{ github.repository }}#readme)
          EOF
      
      # åˆ›å»ºRelease
      - name: åˆ›å»ºGitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "ğŸ‰ My Awesome App v${{ steps.version.outputs.version }}"
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: release-files/*
          make_latest: true
          generate_release_notes: true
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # éªŒè¯Releaseåˆ›å»º
      - name: éªŒè¯Releaseåˆ›å»º
        run: |
          echo "â³ ç­‰å¾…Releaseå®Œå…¨åˆ›å»º..."
          sleep 15
          
          echo "=== ğŸ” éªŒè¯ReleaseçŠ¶æ€ ==="
          response=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                          "https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ steps.version.outputs.tag }}")
          
          if echo "$response" | jq -e '.tag_name' > /dev/null; then
            echo "âœ… Releaseåˆ›å»ºæˆåŠŸ"
            
            release_url=$(echo "$response" | jq -r '.html_url')
            assets_count=$(echo "$response" | jq '.assets | length')
            
            echo "ğŸ”— Release URL: $release_url"
            echo "ğŸ“¦ åŒ…å«æ–‡ä»¶: $assets_count ä¸ª"
            
            if [ $assets_count -gt 0 ]; then
              echo ""
              echo "ğŸ“‹ æ–‡ä»¶æ¸…å•:"
              echo "$response" | jq -r '.assets[] | "  âœ“ \(.name) (\((.size / 1024 / 1024 * 100 | floor) / 100)MB)"'
              
              # æ£€æŸ¥å…³é”®æ–‡ä»¶
              echo ""
              echo "ğŸ” å¹³å°æ–‡ä»¶æ£€æŸ¥:"
              if echo "$response" | jq -e '.assets[] | select(.name | test("\\.exe$"))' > /dev/null; then
                echo "  âœ… Windowsæ–‡ä»¶å·²åŒ…å«"
              else
                echo "  âš ï¸ æœªæ‰¾åˆ°Windowsæ–‡ä»¶"
              fi
              
              if echo "$response" | jq -e '.assets[] | select(.name | test("\\.dmg$"))' > /dev/null; then
                echo "  âœ… macOSæ–‡ä»¶å·²åŒ…å«"
              else
                echo "  âš ï¸ æœªæ‰¾åˆ°macOSæ–‡ä»¶"
              fi
              
              if echo "$response" | jq -e '.assets[] | select(.name | test("\\.AppImage$"))' > /dev/null; then
                echo "  âœ… Linuxæ–‡ä»¶å·²åŒ…å«"
              else
                echo "  âš ï¸ æœªæ‰¾åˆ°Linuxæ–‡ä»¶"
              fi
              
            else
              echo "âš ï¸ Releaseåˆ›å»ºæˆåŠŸä½†æ²¡æœ‰é™„åŠ æ–‡ä»¶"
            fi
            
          else
            echo "âŒ ReleaseéªŒè¯å¤±è´¥"
            echo "APIå“åº”: $response"
            exit 1
          fi
      
      # å‘å¸ƒæˆåŠŸé€šçŸ¥
      - name: ğŸ‰ å‘å¸ƒæˆåŠŸé€šçŸ¥
        run: |
          echo ""
          echo "ğŸ‰ğŸ‰ğŸ‰ å‘å¸ƒå®Œæˆ! ğŸ‰ğŸ‰ğŸ‰"
          echo ""
          echo "ğŸ“Š å‘å¸ƒæ‘˜è¦:"
          echo "  ğŸ·ï¸ åº”ç”¨åç§°: My Awesome App"
          echo "  ğŸ“‹ ç‰ˆæœ¬å·: ${{ steps.version.outputs.version }}"
          echo "  ğŸ”– Gitæ ‡ç­¾: ${{ steps.version.outputs.tag }}"
          echo "  ğŸ“… å‘å¸ƒæ—¶é—´: $(date)"
          echo ""
          echo "ğŸ”— ç”¨æˆ·ä¸‹è½½åœ°å€:"
          echo "  https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"
          echo ""
          echo "âœ¨ ç‰¹æ€§è¯´æ˜:"
          echo "  ğŸªŸ æ”¯æŒ Windows 10/11 (x64)"
          echo "  ğŸ æ”¯æŒ macOS Intel & Apple Silicon"
          echo "  ğŸ§ æ”¯æŒä¸»æµ Linux å‘è¡Œç‰ˆ"
          echo "  ğŸ”„ å†…ç½®è‡ªåŠ¨æ›´æ–°åŠŸèƒ½"
          echo ""
          echo "ğŸ“± ç”¨æˆ·ç°åœ¨å¯ä»¥ä¸‹è½½å¹¶å®‰è£…æœ€æ–°ç‰ˆæœ¬!"

  # æ¸…ç†å·¥ä»¶
  cleanup:
    name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    needs: [build, release]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: æ¸…ç†æ„å»ºå·¥ä»¶
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            Windows-v${{ github.run_number }}
            macOS-v${{ github.run_number }}
            Linux-v${{ github.run_number }}
        continue-on-error: true
      
      - name: æ¸…ç†å®Œæˆ
        run: echo "ğŸ§¹ ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"