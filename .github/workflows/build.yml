name: æ„å»ºå’Œå‘å¸ƒ

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.18)"
        required: true
        default: "1.0.18"
      environment:
        description: "æ„å»ºç¯å¢ƒ (PROD, DEV, SIT, DEMO)"
        required: false
        default: "PROD"
        type: choice
        options:
          - "PROD"
          - "DEV"
          - "SIT"
          - "DEMO"

permissions:
  contents: write

jobs:
  # æ„å»ºé˜¶æ®µ - å®Œå…¨ç¦ç”¨è‡ªåŠ¨å‘å¸ƒ
  build:
    name: æ„å»º ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            name: Windows
            platform: win
          - os: macos-latest
            name: macOS
            platform: mac
          - os: ubuntu-latest
            name: Linux
            platform: linux

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          # ä½¿ç”¨ç‰¹å®šSHAé¿å…æ ‡ç­¾ä¿¡æ¯
          ref: ${{ github.sha }}

      - name: æ˜¾ç¤ºå½“å‰ç›®å½• (Build Job)
        run: |
          echo "â¡ï¸ Current directory (build job start):"
          pwd

      - name: è§£æç¯å¢ƒä¿¡æ¯
        id: parse_env
        shell: bash
        run: |
          # ä»git tagæˆ–æ‰‹åŠ¨è¾“å…¥è§£æç¯å¢ƒ
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
            # ä»æ ‡ç­¾è§£æç¯å¢ƒ (æ”¯æŒå¿½ç•¥å¤§å°å†™)
            TAG_NAME="${{ github.ref }}"
            TAG_NAME=${TAG_NAME#refs/tags/}
            echo "ğŸ“‹ æ£€æµ‹åˆ°æ ‡ç­¾: $TAG_NAME"
            
            # æå–ç¯å¢ƒåç¼€å¹¶è½¬æ¢ä¸ºå¤§å†™
            if [[ $TAG_NAME =~ -([a-zA-Z]+)$ ]]; then
              ENV_SUFFIX="${BASH_REMATCH[1]}"
              ENV_SUFFIX=$(echo "$ENV_SUFFIX" | tr '[:lower:]' '[:upper:]')
              echo "ğŸ¯ æ£€æµ‹åˆ°ç¯å¢ƒåç¼€: $ENV_SUFFIX"
              
              case $ENV_SUFFIX in
                "DEV"|"DEVELOPMENT")
                  BUILD_ENV="DEV"
                  ;;
                "SIT"|"STAGING")
                  BUILD_ENV="SIT"
                  ;;
                "DEMO"|"DEMONSTRATION")
                  BUILD_ENV="DEMO"
                  ;;
                "PROD"|"PRODUCTION")
                  BUILD_ENV="PROD"
                  ;;
                *)
                  echo "âš ï¸ æœªè¯†åˆ«çš„ç¯å¢ƒåç¼€: $ENV_SUFFIXï¼Œé»˜è®¤ä½¿ç”¨ PROD"
                  BUILD_ENV="PROD"
                  ;;
              esac
            else
              echo "ğŸ“¦ æ— ç¯å¢ƒåç¼€ï¼Œé»˜è®¤ä½¿ç”¨ PROD"
              BUILD_ENV="PROD"
            fi
          else
            # æ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨è¾“å…¥çš„ç¯å¢ƒ
            BUILD_ENV="${{ github.event.inputs.environment || 'PROD' }}"
          fi

          echo "ğŸš€ æ„å»ºç¯å¢ƒ: $BUILD_ENV"
          echo "BUILD_ENVIRONMENT=$BUILD_ENV" >> $GITHUB_OUTPUT
          echo "BUILD_ENVIRONMENT=$BUILD_ENV" >> $GITHUB_ENV

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      # macOSä¸“ç”¨ï¼šä¿®å¤DMGæ„å»ºé—®é¢˜
      - name: ğŸ macOS DMGæ„å»ºç¯å¢ƒå‡†å¤‡
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          echo "ğŸ§¹ å‡†å¤‡macOSæ„å»ºç¯å¢ƒ..."
          
          # è·å–åº”ç”¨ä¿¡æ¯
          PRODUCT_NAME=$(node -p "require('./package.json').build?.productName || require('./package.json').name")
          VERSION=$(node -p "require('./package.json').version")
          
          echo "ğŸ“± åº”ç”¨åç§°: $PRODUCT_NAME"
          echo "ğŸ·ï¸ ç‰ˆæœ¬: $VERSION"
          
          # å®šä¹‰å¯èƒ½çš„å·åç§°
          VOLUME_PATTERNS=(
            "$PRODUCT_NAME $VERSION"
            "BMO Middle Office $VERSION"
            "My Awesome App $VERSION"
            "$PRODUCT_NAME"
          )
          
          echo "ğŸ” æ£€æŸ¥å¹¶æ¸…ç†ç°æœ‰å·..."
          
          for VOLUME_NAME in "${VOLUME_PATTERNS[@]}"; do
            VOLUME_PATH="/Volumes/$VOLUME_NAME"
            
            if [ -d "$VOLUME_PATH" ]; then
              echo "ğŸ“± å‘ç°ç°æœ‰å·: $VOLUME_PATH"
              
              # ç»ˆæ­¢ä½¿ç”¨è¯¥å·çš„è¿›ç¨‹
              echo "ğŸ”„ ç»ˆæ­¢ä½¿ç”¨å·çš„è¿›ç¨‹..."
              sudo lsof +D "$VOLUME_PATH" 2>/dev/null | awk 'NR>1 {print $2}' | xargs -r sudo kill -9 2>/dev/null || true
              
              # ç­‰å¾…è¿›ç¨‹ç»ˆæ­¢
              sleep 2
              
              # å°è¯•å¤šç§æ–¹æ³•å¸è½½
              echo "ğŸ”„ å°è¯•å¸è½½å·..."
              sudo diskutil unmount force "$VOLUME_PATH" 2>/dev/null || true
              sudo hdiutil detach "$VOLUME_PATH" -force -quiet 2>/dev/null || true
              
              # éªŒè¯æ¸…ç†ç»“æœ
              if [ -d "$VOLUME_PATH" ]; then
                echo "âš ï¸ å·ä»ç„¶å­˜åœ¨ï¼Œå°è¯•æ›´å¼ºåˆ¶çš„æ–¹æ³•..."
                sudo umount -f "$VOLUME_PATH" 2>/dev/null || true
              else
                echo "âœ… å·å·²æˆåŠŸæ¸…ç†: $VOLUME_NAME"
              fi
            fi
          done
          
          # æ¸…ç†å­¤ç«‹çš„ç£ç›˜é•œåƒ
          echo "ğŸ”„ æ¸…ç†å­¤ç«‹çš„ç£ç›˜é•œåƒ..."
          hdiutil info 2>/dev/null | grep -E "(BMO|My.*Awesome.*App)" | awk '{print $1}' | xargs -r sudo hdiutil detach -force 2>/dev/null || true
          
          # æ¸…ç†æ—§çš„æ„å»ºæ–‡ä»¶
          echo "ğŸ—‘ï¸ æ¸…ç†æ—§çš„æ„å»ºæ–‡ä»¶..."
          rm -rf dist/ build/ *.dmg 2>/dev/null || true
          
          # ä¼˜åŒ–ç³»ç»Ÿè®¾ç½®
          echo "âš™ï¸ ä¼˜åŒ–ç³»ç»Ÿè®¾ç½®..."
          sudo sysctl -w kern.maxfiles=65536 2>/dev/null || true
          sudo sysctl -w kern.maxfilesperproc=65536 2>/dev/null || true
          
          # ç¦ç”¨Spotlightç´¢å¼•ä»¥é¿å…æ–‡ä»¶é”å®š
          echo "ğŸ” ä¸´æ—¶ç¦ç”¨Spotlightç´¢å¼•..."
          sudo mdutil -a -i off 2>/dev/null || true
          
          # ç­‰å¾…ç³»ç»Ÿç¨³å®š
          echo "â³ ç­‰å¾…ç³»ç»Ÿç¨³å®š..."
          sleep 3
          
          echo "âœ… macOSæ„å»ºç¯å¢ƒå‡†å¤‡å®Œæˆ"

      # ç¼–è¯‘ TypeScript ä»£ç å’Œå‡†å¤‡æ–‡ä»¶
      - name: ç¼–è¯‘å’Œå‡†å¤‡æ–‡ä»¶
        run: |
          echo "â¡ï¸ Current directory (before compile):"
          pwd
          npm run build

      # éªŒè¯ç¼–è¯‘ç»“æœ
      - name: éªŒè¯ç¼–è¯‘ç»“æœ
        shell: bash
        run: |
          echo "=== TypeScript ç¼–è¯‘éªŒè¯ ==="
          if [ -f "release/main.js" ]; then
            echo "âœ… main.js ç¼–è¯‘æˆåŠŸ"
            ls -la release/
          else
            echo "âŒ TypeScript ç¼–è¯‘å¤±è´¥: main.js ä¸å­˜åœ¨"
            exit 1
          fi

          if [ -f "release/index.html" ]; then
            echo "âœ… index.html å¤åˆ¶æˆåŠŸ"
          else
            echo "âŒ èµ„æºå¤åˆ¶å¤±è´¥: index.html ä¸å­˜åœ¨"
            exit 1
          fi

      # å½»åº•æ¸…ç†Gitç¯å¢ƒé˜²æ­¢electron-builderæ£€æµ‹æ ‡ç­¾
      - name: æ¸…ç†Gitæ ‡ç­¾ç¯å¢ƒ
        shell: bash
        run: |
          echo "æ¸…ç†Gitç¯å¢ƒä»¥é˜²æ­¢electron-builderè‡ªåŠ¨å‘å¸ƒ..."

          # ç§»é™¤æ‰€æœ‰è¿œç¨‹å¼•ç”¨
          git remote remove origin || true

          # åˆ é™¤æ‰€æœ‰æ ‡ç­¾
          git tag -l | xargs -r git tag -d

          # é‡æ–°åˆå§‹åŒ–ä¸ºæ™®é€šä»“åº“
          rm -rf .git/refs/remotes
          rm -rf .git/refs/tags

          # éªŒè¯æ¸…ç†ç»“æœ
          echo "å½“å‰GitçŠ¶æ€:"
          git status || echo "GitçŠ¶æ€æ£€æŸ¥å®Œæˆ"
          git tag -l || echo "æ— æ ‡ç­¾"

          echo "âœ… Gitç¯å¢ƒå·²æ¸…ç†ï¼Œelectron-builderä¸ä¼šæ£€æµ‹åˆ°å‘å¸ƒæ¡ä»¶"

      # ç”Ÿæˆæ„å»ºé…ç½®
      - name: Generate electron-builder config
        run: |
          echo "â¡ï¸ Deleting old config file..."
          npx shx rm -f electron-builder.json
          echo "â¡ï¸ Generating new config for ${{ steps.parse_env.outputs.BUILD_ENVIRONMENT }}..."
          npm run config:ts:${{ steps.parse_env.outputs.BUILD_ENVIRONMENT }}
          echo "âœ… Config generated. Contents:"
          cat electron-builder.json

      # macOSæ„å»ºåæ¸…ç†å‡†å¤‡
      - name: ğŸ macOSæ„å»ºåæ¸…ç†å‡†å¤‡
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          echo "ğŸ”§ è®¾ç½®æ„å»ºåæ¸…ç†é’©å­..."
          
          # åˆ›å»ºæ¸…ç†è„šæœ¬
          cat > cleanup-volumes.sh << 'EOF'
          #!/bin/bash
          
          echo "ğŸ§¹ æ‰§è¡Œæ„å»ºåå·æ¸…ç†..."
          
          # è·å–åº”ç”¨ä¿¡æ¯
          PRODUCT_NAME=$(node -p "require('./package.json').build?.productName || require('./package.json').name" 2>/dev/null || echo "BMO Middle Office")
          VERSION=$(node -p "require('./package.json').version" 2>/dev/null || echo "2.0.4")
          
          echo "ğŸ“± æ¸…ç†åº”ç”¨: $PRODUCT_NAME v$VERSION"
          
          # å¼ºåˆ¶æ¸…ç†æ‰€æœ‰ç›¸å…³å·
          for pattern in "$PRODUCT_NAME $VERSION" "BMO Middle Office $VERSION" "My Awesome App $VERSION"; do
            VOLUME_PATH="/Volumes/$pattern"
            if [ -d "$VOLUME_PATH" ]; then
              echo "ğŸ”„ æ¸…ç†å·: $VOLUME_PATH"
              sudo lsof +D "$VOLUME_PATH" 2>/dev/null | awk 'NR>1 {print $2}' | xargs -r sudo kill -9 2>/dev/null || true
              sleep 1
              sudo diskutil unmount force "$VOLUME_PATH" 2>/dev/null || true
              sudo hdiutil detach "$VOLUME_PATH" -force -quiet 2>/dev/null || true
            fi
          done
          
          # æ¸…ç†æ‰€æœ‰BMOç›¸å…³å·
          for vol in /Volumes/*"BMO"* /Volumes/*"My Awesome App"* /Volumes/*"Middle Office"*; do
            if [ -d "$vol" ]; then
              echo "ğŸ”„ å¼ºåˆ¶æ¸…ç†: $vol"
              sudo diskutil unmount force "$vol" 2>/dev/null || true
              sudo hdiutil detach "$vol" -force 2>/dev/null || true
            fi
          done
          
          echo "âœ… å·æ¸…ç†å®Œæˆ"
          EOF
          
          chmod +x cleanup-volumes.sh

      # æ„å»º - å¢å¼ºç‰ˆæœ¬
      - name: ğŸ”¨ æ„å»º ${{ matrix.name }}
        shell: bash
        run: |
          echo "â¡ï¸ Current directory (before package):"
          pwd
          
          # macOSç‰¹æ®Šå¤„ç†
          if [[ "${{ matrix.os }}" == "macos-latest" ]]; then
            echo "ğŸ å¼€å§‹macOSæ„å»º (å¢å¼ºç‰ˆæœ¬)..."
            
            # è®¾ç½®Node.jsé€‰é¡¹ä»¥å¤„ç†å¤§é‡äº‹ä»¶ç›‘å¬å™¨
            export NODE_OPTIONS="--max-old-space-size=4096 --max-listeners=50"
            export UV_USE_IO_URING=0
            
            # æ„å»ºå‰æœ€åæ¸…ç†
            echo "ğŸ§¹ æ„å»ºå‰æœ€åæ¸…ç†..."
            ./cleanup-volumes.sh
            
            # ä½¿ç”¨trapç¡®ä¿æ„å»ºå¤±è´¥æ—¶ä¹Ÿèƒ½æ¸…ç†
            trap './cleanup-volumes.sh' EXIT
            
            echo "ğŸ”¨ æ‰§è¡ŒmacOSæ„å»º..."
            timeout 30m npm run build:${{ matrix.platform }} || {
              echo "âš ï¸ æ„å»ºè¶…æ—¶æˆ–å¤±è´¥ï¼Œæ‰§è¡Œç´§æ€¥æ¸…ç†..."
              ./cleanup-volumes.sh
              
              # å¼ºåˆ¶æ¸…ç†æ‰€æœ‰ç›¸å…³è¿›ç¨‹
              sudo pkill -f "hdiutil" 2>/dev/null || true
              sudo pkill -f "BMO" 2>/dev/null || true
              sudo pkill -f "Middle Office" 2>/dev/null || true
              
              # ç­‰å¾…ç³»ç»Ÿç¨³å®šåé‡è¯•ä¸€æ¬¡
              sleep 5
              echo "ğŸ”„ é‡è¯•æ„å»º..."
              npm run build:${{ matrix.platform }}
            }
            
          else
            # Windowså’ŒLinuxæ­£å¸¸æ„å»º
            echo "ğŸ”¨ å¼€å§‹ ${{ matrix.name }} æ„å»º..."
            npm run build:${{ matrix.platform }}
          fi
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BUILD_ENVIRONMENT: ${{ steps.parse_env.outputs.BUILD_ENVIRONMENT }}
          # å¢åŠ Node.jså†…å­˜é™åˆ¶
          NODE_OPTIONS: --max-old-space-size=4096

      # macOSæ„å»ºåå¼ºåˆ¶æ¸…ç†
      - name: ğŸ macOSæ„å»ºåå¼ºåˆ¶æ¸…ç†
        if: matrix.os == 'macos-latest' && always()
        shell: bash
        run: |
          echo "ğŸ§¹ æ‰§è¡Œæ„å»ºåå¼ºåˆ¶æ¸…ç†..."
          
          # æ‰§è¡Œæ¸…ç†è„šæœ¬
          ./cleanup-volumes.sh
          
          # é¢å¤–çš„å¼ºåˆ¶æ¸…ç†æªæ–½
          echo "ğŸ”„ é¢å¤–å¼ºåˆ¶æ¸…ç†æªæ–½..."
          
          # ç»ˆæ­¢æ‰€æœ‰ç›¸å…³è¿›ç¨‹
          sudo pkill -f "hdiutil" 2>/dev/null || true
          sudo pkill -f "BMO" 2>/dev/null || true
          sudo pkill -f "Middle Office" 2>/dev/null || true
          sudo pkill -f "My Awesome App" 2>/dev/null || true
          
          # å¼ºåˆ¶å¸è½½æ‰€æœ‰å¯èƒ½çš„å·
          for vol in /Volumes/*; do
            if [[ "$vol" == *"BMO"* || "$vol" == *"Middle Office"* || "$vol" == *"My Awesome App"* ]]; then
              echo "ğŸ”„ å¼ºåˆ¶æ¸…ç†å·: $vol"
              sudo diskutil unmount force "$vol" 2>/dev/null || true
              sudo hdiutil detach "$vol" -force 2>/dev/null || true
            fi
          done
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f cleanup-volumes.sh
          
          # é‡æ–°å¯ç”¨Spotlightï¼ˆå¦‚æœä¹‹å‰ç¦ç”¨äº†ï¼‰
          sudo mdutil -a -i on 2>/dev/null || true
          
          echo "âœ… macOSæ„å»ºåæ¸…ç†å®Œæˆ"

      # éªŒè¯æ„å»ºç»“æœ - ä½¿ç”¨ç›®æ ‡ç¯å¢ƒ
      - name: éªŒè¯æ„å»ºç»“æœ
        shell: bash
        run: |
          echo "=== ${{ matrix.name }} æ„å»ºéªŒè¯ (ç¯å¢ƒ: ${{ steps.parse_env.outputs.BUILD_ENVIRONMENT }}) ==="

          # åªæ£€æŸ¥ç›®æ ‡ç¯å¢ƒç›®å½•
          TARGET_ENV="${{ steps.parse_env.outputs.BUILD_ENVIRONMENT }}"
          BUILD_DIR="BMO-MO-APP-RELEASES/$TARGET_ENV"

          if [ -d "$BUILD_DIR" ]; then
            echo "ğŸ“ æ‰¾åˆ°æ„å»ºç›®å½•: $BUILD_DIR"
            
            # æŸ¥æ‰¾æ„å»ºæ–‡ä»¶
            BUILD_FILES=$(find "$BUILD_DIR" -name "*.exe" -o -name "*.dmg" -o -name "*.zip" -o -name "*.deb" -o -name "*.rpm" -o -name "*.AppImage" 2>/dev/null || true)
            
            if [ -n "$BUILD_FILES" ]; then
              echo "âœ… æ‰¾åˆ°æ„å»ºæ–‡ä»¶:"
              echo "$BUILD_FILES" | while read -r file; do
                [ -n "$file" ] && ls -lh "$file"
              done
              
              FILE_COUNT=$(echo "$BUILD_FILES" | grep -c . || echo 0)
              echo "ğŸ“Š æ„å»ºç»Ÿè®¡: æ‰¾åˆ° $FILE_COUNT ä¸ªæ„å»ºæ–‡ä»¶"
              echo "âœ… ${{ matrix.name }} æ„å»ºæˆåŠŸ"
            else
              echo "âŒ ${{ matrix.name }} æ„å»ºå¤±è´¥: ç›®å½•å­˜åœ¨ä½†æœªæ‰¾åˆ°æ„å»ºæ–‡ä»¶"
              
              # æ˜¾ç¤ºç›®å½•å†…å®¹å¸®åŠ©è°ƒè¯•
              echo "ğŸ” è°ƒè¯•ä¿¡æ¯ - ç›®å½•å†…å®¹:"
              find "$BUILD_DIR" -type f | head -20
              exit 1
            fi
          else
            echo "âŒ ${{ matrix.name }} æ„å»ºå¤±è´¥: æœªæ‰¾åˆ°ç›®æ ‡ç¯å¢ƒç›®å½• $BUILD_DIR"
            echo "å½“å‰ç›®å½•ç»“æ„:"
            find . -maxdepth 2 -type d | head -10
            exit 1
          fi

      # ä¸Šä¼ æ„å»ºäº§ç‰© - åªä¸Šä¼ ç›®æ ‡ç¯å¢ƒ
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-${{ steps.parse_env.outputs.BUILD_ENVIRONMENT }}-v${{ github.run_number }}
          path: |
            BMO-MO-APP-RELEASES/${{ steps.parse_env.outputs.BUILD_ENVIRONMENT }}/*
          retention-days: 7
          compression-level: 6
          if-no-files-found: warn

  # å‘å¸ƒé˜¶æ®µ
  release:
    name: åˆ›å»ºGitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: needs.build.result == 'success'
    timeout-minutes: 30

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: æ˜¾ç¤ºå½“å‰ç›®å½• (Release Job)
        run: |
          echo "â¡ï¸ Current directory (release job start):"
          pwd

      - name: è§£æç¯å¢ƒä¿¡æ¯
        id: parse_env
        shell: bash
        run: |
          # ä»git tagæˆ–æ‰‹åŠ¨è¾“å…¥è§£æç¯å¢ƒ
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
            # ä»æ ‡ç­¾è§£æç¯å¢ƒ (æ”¯æŒå¿½ç•¥å¤§å°å†™)
            TAG_NAME="${{ github.ref }}"
            TAG_NAME=${TAG_NAME#refs/tags/}
            echo "ğŸ“‹ æ£€æµ‹åˆ°æ ‡ç­¾: $TAG_NAME"
            
            # æå–ç¯å¢ƒåç¼€å¹¶è½¬æ¢ä¸ºå¤§å†™
            if [[ $TAG_NAME =~ -([a-zA-Z]+)$ ]]; then
              ENV_SUFFIX="${BASH_REMATCH[1]}"
              ENV_SUFFIX=$(echo "$ENV_SUFFIX" | tr '[:lower:]' '[:upper:]')
              echo "ğŸ¯ æ£€æµ‹åˆ°ç¯å¢ƒåç¼€: $ENV_SUFFIX"
              
              case $ENV_SUFFIX in
                "DEV"|"DEVELOPMENT")
                  BUILD_ENV="DEV"
                  ;;
                "SIT"|"STAGING")
                  BUILD_ENV="SIT"
                  ;;
                "DEMO"|"DEMONSTRATION")
                  BUILD_ENV="DEMO"
                  ;;
                "PROD"|"PRODUCTION")
                  BUILD_ENV="PROD"
                  ;;
                *)
                  echo "âš ï¸ æœªè¯†åˆ«çš„ç¯å¢ƒåç¼€: $ENV_SUFFIXï¼Œé»˜è®¤ä½¿ç”¨ PROD"
                  BUILD_ENV="PROD"
                  ;;
              esac
            else
              echo "ğŸ“¦ æ— ç¯å¢ƒåç¼€ï¼Œé»˜è®¤ä½¿ç”¨ PROD"
              BUILD_ENV="PROD"
            fi
          else
            # æ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨è¾“å…¥çš„ç¯å¢ƒ
            BUILD_ENV="${{ github.event.inputs.environment || 'PROD' }}"
          fi

          echo "ğŸš€ å‘å¸ƒç¯å¢ƒ: $BUILD_ENV"
          echo "BUILD_ENVIRONMENT=$BUILD_ENV" >> $GITHUB_OUTPUT
          echo "BUILD_ENVIRONMENT=$BUILD_ENV" >> $GITHUB_ENV

      - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="${{ github.event.inputs.version || '1.0.18' }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ å‘å¸ƒç‰ˆæœ¬: $VERSION"

      # ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      # æ•´ç†å‘å¸ƒæ–‡ä»¶
      - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
        run: |
          mkdir -p release-files

          echo "=== ğŸ“ æ£€æŸ¥ä¸‹è½½çš„æ„å»ºäº§ç‰© (ç¯å¢ƒ: ${{ steps.parse_env.outputs.BUILD_ENVIRONMENT }}) ==="
          find artifacts/ -type f \( \
            -name "*.exe" -o \
            -name "*.dmg" -o \
            -name "*.zip" -o \
            -name "*.deb" -o \
            -name "*.rpm" -o \
            -name "*.AppImage" -o \
            -name "*.yml" -o \
            -name "*.blockmap" \
          \) -exec ls -lh {} \;

          # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶åˆ°releaseç›®å½•
          find artifacts/ -type f \( \
            -name "*.exe" -o \
            -name "*.dmg" -o \
            -name "*.zip" -o \
            -name "*.deb" -o \
            -name "*.rpm" -o \
            -name "*.AppImage" -o \
            -name "*.yml" -o \
            -name "*.blockmap" \
          \) -exec cp {} release-files/ \;

          echo ""
          echo "=== å‡†å¤‡å‘å¸ƒçš„æ–‡ä»¶ ==="
          ls -lah release-files/

          # ç»Ÿè®¡æ–‡ä»¶ä¿¡æ¯
          file_count=$(ls -1 release-files/ | wc -l)
          total_size=$(du -sh release-files/ | cut -f1)

          echo ""
          echo "ğŸ“Š å‘å¸ƒç»Ÿè®¡:"
          echo "  ğŸ“ æ–‡ä»¶æ•°é‡: $file_count"
          echo "  ğŸ’¾ æ€»å¤§å°: $total_size"
          echo "  ğŸ¯ æ„å»ºç¯å¢ƒ: ${{ steps.parse_env.outputs.BUILD_ENVIRONMENT }}"

          # åˆ†ç±»ç»Ÿè®¡
          windows_count=$(ls -1 release-files/*.exe 2>/dev/null | wc -l || echo 0)
          macos_count=$(ls -1 release-files/*.dmg 2>/dev/null | wc -l || echo 0)
          linux_count=$(ls -1 release-files/*.AppImage 2>/dev/null | wc -l || echo 0)

          echo "  ğŸªŸ Windowsæ–‡ä»¶: $windows_count"
          echo "  ğŸ macOSæ–‡ä»¶: $macos_count"
          echo "  ğŸ§ Linuxæ–‡ä»¶: $linux_count"

          if [ $file_count -eq 0 ]; then
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°å¯å‘å¸ƒçš„æ–‡ä»¶"
            exit 1
          fi

      # ç”ŸæˆReleaseè¯´æ˜
      - name: ç”ŸæˆReleaseè¯´æ˜
        run: |
          ENV_LABEL=""
          case "${{ steps.parse_env.outputs.BUILD_ENVIRONMENT }}" in
            "DEV")
              ENV_LABEL=" (å¼€å‘ç‰ˆ)"
              ;;
            "SIT")
              ENV_LABEL=" (æµ‹è¯•ç‰ˆ)"
              ;;
            "DEMO")
              ENV_LABEL=" (æ¼”ç¤ºç‰ˆ)"
              ;;
            "PROD")
              ENV_LABEL=""
              ;;
          esac

          cat > release_notes.md << EOF
          ## ğŸš€ My Awesome App v${{ steps.version.outputs.version }}$ENV_LABEL

          > **æ„å»ºç¯å¢ƒ**: ${{ steps.parse_env.outputs.BUILD_ENVIRONMENT }}  
          > **æ„å»ºæ—¶é—´**: $(date)

          ### ğŸ“¦ æ”¯æŒå¹³å°

          **ğŸªŸ Windows (x64)**
          - NSISå®‰è£…ç¨‹åº (æ¨è) - åŒå‡»å®‰è£…ï¼Œæ”¯æŒè‡ªåŠ¨æ›´æ–°
          - ä¾¿æºç‰ˆæœ¬ - ç»¿è‰²ç‰ˆï¼Œæ— éœ€å®‰è£…

          **ğŸ macOS**
          - Intel Mac (x64) - æ”¯æŒmacOS 10.15+
          - Apple Silicon (ARM64) - åŸç”ŸMç³»åˆ—èŠ¯ç‰‡æ”¯æŒ

          **ğŸ§ Linux (x64)**
          - AppImage - é€šç”¨ä¾¿æºç‰ˆæœ¬ï¼Œé€‚ç”¨äºæ‰€æœ‰å‘è¡Œç‰ˆ
          - Debian/Ubuntu (.deb) - ç³»ç»ŸåŒ…ç®¡ç†å™¨å®‰è£…
          - CentOS/Fedora (.rpm) - ç³»ç»ŸåŒ…ç®¡ç†å™¨å®‰è£…

          ### ğŸ“ å®‰è£…æŒ‡å—

          **Windows:**
          1. ä¸‹è½½ \`my-awesome-app-*-win-x64.exe\` (NSISå®‰è£…ç¨‹åº)
          2. åŒå‡»è¿è¡Œï¼ŒæŒ‰å‘å¯¼å®‰è£…
          3. å¦‚é‡å®‰å…¨æç¤ºï¼Œç‚¹å‡»"æ›´å¤šä¿¡æ¯" â†’ "ä»è¦è¿è¡Œ"

          **macOS:**
          1. æ ¹æ®èŠ¯ç‰‡ç±»å‹ä¸‹è½½å¯¹åº”çš„ \`.dmg\` æ–‡ä»¶
          2. åŒå‡»æŒ‚è½½ï¼Œæ‹–æ‹½åº”ç”¨åˆ° Applications æ–‡ä»¶å¤¹
          3. é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦å³é”®ç‚¹å‡» â†’ "æ‰“å¼€"

          **Linux:**
          1. **AppImage (æ¨è)**: ä¸‹è½½åæ·»åŠ æ‰§è¡Œæƒé™ \`chmod +x *.AppImage\`
          2. **Ubuntu/Debian**: \`sudo dpkg -i *.deb\`
          3. **CentOS/Fedora**: \`sudo rpm -i *.rpm\`

          ### ğŸ”„ è‡ªåŠ¨æ›´æ–°

          âœ… åº”ç”¨å†…ç½®è‡ªåŠ¨æ›´æ–°åŠŸèƒ½  
          âœ… å®‰è£…åä¼šè‡ªåŠ¨æ£€æµ‹æ–°ç‰ˆæœ¬  
          âœ… æ”¯æŒå¢é‡æ›´æ–°ï¼ŒèŠ‚çœä¸‹è½½æ—¶é—´  

          ### ğŸ› ï¸ æŠ€æœ¯ä¿¡æ¯

          - **Electron**: 28.2.4
          - **Node.js**: 20.x  
          - **æ„å»ºå¹³å°**: GitHub Actions
          - **æ„å»ºç¯å¢ƒ**: ${{ steps.parse_env.outputs.BUILD_ENVIRONMENT }}

          ### ğŸ“ æ–‡ä»¶æ ¡éªŒ

          æ‰€æœ‰æ–‡ä»¶éƒ½åŒ…å«SHAæ ¡éªŒå€¼ (.blockmapæ–‡ä»¶)ï¼Œç¡®ä¿ä¸‹è½½å®Œæ•´æ€§ã€‚

          ---

          **ğŸ”— ç›¸å…³é“¾æ¥**
          - [ğŸ“– æºä»£ç ](https://github.com/${{ github.repository }})
          - [ğŸ› é—®é¢˜åé¦ˆ](https://github.com/${{ github.repository }}/issues)
          - [ğŸ“ æ›´æ–°æ—¥å¿—](https://github.com/${{ github.repository }}/releases)
          - [ğŸ“š ä½¿ç”¨æ–‡æ¡£](https://github.com/${{ github.repository }}#readme)
          EOF

      # åˆ›å»ºRelease
      - name: åˆ›å»ºGitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "ğŸ‰ My Awesome App v${{ steps.version.outputs.version }} [${{ steps.parse_env.outputs.BUILD_ENVIRONMENT }}]"
          body_path: release_notes.md
          draft: false
          prerelease: ${{ steps.parse_env.outputs.BUILD_ENVIRONMENT != 'PROD' }}
          files: release-files/*
          make_latest: ${{ steps.parse_env.outputs.BUILD_ENVIRONMENT == 'PROD' }}
          generate_release_notes: true
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # éªŒè¯Releaseåˆ›å»º
      - name: éªŒè¯Releaseåˆ›å»º
        run: |
          echo "â³ ç­‰å¾…Releaseå®Œå…¨åˆ›å»º..."
          sleep 15

          echo "=== ğŸ“ éªŒè¯ReleaseçŠ¶æ€ ==="
          response=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                          "https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ steps.version.outputs.tag }}")

          if echo "$response" | jq -e '.tag_name' > /dev/null; then
            echo "âœ… Releaseåˆ›å»ºæˆåŠŸ"
            
            release_url=$(echo "$response" | jq -r '.html_url')
            assets_count=$(echo "$response" | jq '.assets | length')
            is_prerelease=$(echo "$response" | jq -r '.prerelease')
            
            echo "ğŸ”— Release URL: $release_url"
            echo "ğŸ“¦ åŒ…å«æ–‡ä»¶: $assets_count ä¸ª"
            echo "ğŸ¯ æ„å»ºç¯å¢ƒ: ${{ steps.parse_env.outputs.BUILD_ENVIRONMENT }}"
            echo "ğŸ·ï¸ é¢„å‘å¸ƒç‰ˆ: $is_prerelease"
            
            if [ $assets_count -gt 0 ]; then
              echo ""
              echo "ğŸ“‹ æ–‡ä»¶æ¸…å•:"
              echo "$response" | jq -r '.assets[] | "  âœ“ \(.name) (\((.size / 1024 / 1024 * 100 | floor) / 100)MB)"'
              
              # æ£€æŸ¥å…³é”®æ–‡ä»¶
              echo ""
              echo "ğŸ” å¹³å°æ–‡ä»¶æ£€æŸ¥:"
              if echo "$response" | jq -e '.assets[] | select(.name | test("\\.exe$"))' > /dev/null; then
                echo "  âœ… Windowsæ–‡ä»¶å·²åŒ…å«"
              else
                echo "  âš ï¸ æœªæ‰¾åˆ°Windowsæ–‡ä»¶"
              fi
              
              if echo "$response" | jq -e '.assets[] | select(.name | test("\\.dmg$"))' > /dev/null; then
                echo "  âœ… macOSæ–‡ä»¶å·²åŒ…å«"
              else
                echo "  âš ï¸ æœªæ‰¾åˆ°macOSæ–‡ä»¶"
              fi
              
              if echo "$response" | jq -e '.assets[] | select(.name | test("\\.AppImage$"))' > /dev/null; then
                echo "  âœ… Linuxæ–‡ä»¶å·²åŒ…å«"
              else
                echo "  âš ï¸ æœªæ‰¾åˆ°Linuxæ–‡ä»¶"
              fi
              
            else
              echo "âš ï¸ Releaseåˆ›å»ºæˆåŠŸä½†æ²¡æœ‰é™„åŠ æ–‡ä»¶"
            fi
            
          else
            echo "âŒ ReleaseéªŒè¯å¤±è´¥"
            echo "APIå“åº”": $response"
            exit 1
          fi

      # å‘å¸ƒæˆåŠŸé€šçŸ¥
      - name: ğŸ‰ å‘å¸ƒæˆåŠŸé€šçŸ¥
        run: |
          echo ""
          echo "ğŸ‰ğŸ‰ğŸ‰ å‘å¸ƒå®Œæˆ! ğŸ‰ğŸ‰ğŸ‰"
          echo ""
          echo "ğŸ“Š å‘å¸ƒæ‘˜è¦:"
          echo "  ğŸ·ï¸ åº”ç”¨åç§°: My Awesome App"
          echo "  ğŸ“‹ ç‰ˆæœ¬å·: ${{ steps.version.outputs.version }}"
          echo "  ğŸ“– Gitæ ‡ç­¾: ${{ steps.version.outputs.tag }}"
          echo "  ğŸ¯ æ„å»ºç¯å¢ƒ: ${{ steps.parse_env.outputs.BUILD_ENVIRONMENT }}"
          echo "  ğŸ“… å‘å¸ƒæ—¶é—´: $(date)"
          echo ""
          echo "ğŸ”— ç”¨æˆ·ä¸‹è½½åœ°å€:"
          echo "  https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"
          echo ""
          echo "âœ¨ ç‰¹æ€§è¯´æ˜:"
          echo "  ğŸªŸ æ”¯æŒ Windows 10/11 (x64)"
          echo "  ğŸ æ”¯æŒ macOS Intel & Apple Silicon"
          echo "  ğŸ§ æ”¯æŒä¸»æµ Linux å‘è¡Œç‰ˆ"
          echo "  ğŸ”„ å†…ç½®è‡ªåŠ¨æ›´æ–°åŠŸèƒ½"
          echo ""
          echo "ğŸ“± ç”¨æˆ·ç°åœ¨å¯ä»¥ä¸‹è½½å¹¶å®‰è£…æœ€æ–°ç‰ˆæœ¬!"

  # æ¸…ç†å·¥ä»¶
  cleanup:
    name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    needs: [build, release]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: æ˜¾ç¤ºå½“å‰ç›®å½• (Cleanup Job)
        run: |
          echo "â¡ï¸ Current directory (cleanup job start):"
          pwd

      - name: æ¸…ç†æ„å»ºå·¥ä»¶
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            Windows-*-v${{ github.run_number }}
            macOS-*-v${{ github.run_number }}
            Linux-*-v${{ github.run_number }}
        continue-on-error: true

      - name: æ¸…ç†å®Œæˆ
        run: echo "ğŸ§¹ ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"