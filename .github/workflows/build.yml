name: æ„å»ºå’Œå‘å¸ƒ

# è§¦å‘æ¡ä»¶
on:
  # æ¨é€æ ‡ç­¾æ—¶è§¦å‘
  push:
    tags:
      - 'v*'
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.1)'
        required: true
        default: '1.0.1'
        type: string
      platforms:
        description: 'é€‰æ‹©æ„å»ºå¹³å°'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - windows
          - macos
          - linux

# æƒé™è®¾ç½®
permissions:
  contents: write
  packages: write

# ç¯å¢ƒå˜é‡
env:
  ELECTRON_CACHE: ~/.cache/electron
  ELECTRON_BUILDER_CACHE: ~/.cache/electron-builder

jobs:
  # æ„å»ºä»»åŠ¡
  build:
    name: æ„å»º ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 90  # å¢åŠ æ€»ä½“è¶…æ—¶æ—¶é—´
    
    strategy:
      fail-fast: false  # ä¸€ä¸ªå¹³å°å¤±è´¥ä¸å½±å“å…¶ä»–å¹³å°
      matrix:
        include:
          - os: windows-latest
            platform: win
            name: Windows
            script: publish:win
            cache_key: windows
          - os: macos-latest  
            platform: mac
            name: macOS
            script: publish:mac
            cache_key: macos
          - os: ubuntu-latest
            platform: linux
            name: Linux
            script: publish:linux
            cache_key: linux
    
    # è·³è¿‡ä¸éœ€è¦çš„å¹³å°
    if: |
      github.event_name == 'push' || 
      github.event.inputs.platforms == 'all' ||
      github.event.inputs.platforms == matrix.platform
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•
      
      # è®¾ç½®Node.jsç¯å¢ƒ
      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      # ç¼“å­˜electronå’Œelectron-builder
      - name: ç¼“å­˜Electron
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/electron
            ~/.cache/electron-builder
            ${{ matrix.os == 'windows-latest' && '~\AppData\Local\electron' || '' }}
            ${{ matrix.os == 'windows-latest' && '~\AppData\Local\electron-builder' || '' }}
          key: ${{ matrix.cache_key }}-electron-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ matrix.cache_key }}-electron-
      
      # å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: npm ci
        timeout-minutes: 10
      
      # è®¾ç½®æ„å»ºç¯å¢ƒå˜é‡
      - name: è®¾ç½®æ„å»ºç¯å¢ƒå˜é‡
        shell: bash
        run: |
          # è·å–ç‰ˆæœ¬å·
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="${{ github.event.inputs.version || '1.0.0' }}"
          fi
          echo "BUILD_VERSION=$VERSION" >> $GITHUB_ENV
          
          # è®¾ç½®Windowsç¯å¢ƒå˜é‡
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            echo "CSC_IDENTITY_AUTO_DISCOVERY=false" >> $GITHUB_ENV
          fi
          
          # è®¾ç½®æ„å»ºç›®æ ‡
          echo "Building version: $VERSION on ${{ matrix.name }}"
      
      # Windowsç‰¹æ®Šå¤„ç†
      - name: Windowsæ„å»ºå‡†å¤‡
        if: matrix.platform == 'win'
        shell: powershell
        run: |
          # è®¾ç½®Windowsç‰¹å®šç¯å¢ƒå˜é‡
          echo "WIN_CSC_IDENTITY_AUTO_DISCOVERY=false" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          
          # æ£€æŸ¥ç£ç›˜ç©ºé—´
          Get-WmiObject -Class Win32_LogicalDisk | Select-Object DeviceID, @{Name="Size(GB)";Expression={[math]::Round($_.Size/1GB,2)}}, @{Name="FreeSpace(GB)";Expression={[math]::Round($_.FreeSpace/1GB,2)}}
      
      # æ„å»ºåº”ç”¨ - Windows
      - name: æ„å»ºWindowsåº”ç”¨
        if: matrix.platform == 'win'
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 45
          max_attempts: 3
          retry_wait_seconds: 60
          warning_on_retry: true
          command: npm run ${{ matrix.script }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false
          DEBUG: electron-builder
      
      # æ„å»ºåº”ç”¨ - macOS
      - name: æ„å»ºmacOSåº”ç”¨
        if: matrix.platform == 'mac'
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 45
          max_attempts: 3
          retry_wait_seconds: 60
          warning_on_retry: true
          command: npm run ${{ matrix.script }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEBUG: electron-builder
          # macOSä»£ç ç­¾åï¼ˆå¦‚æœæœ‰è¯ä¹¦ï¼‰
          # CSC_LINK: ${{ secrets.CSC_LINK }}
          # CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          # APPLE_ID: ${{ secrets.APPLE_ID }}
          # APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
      
      # æ„å»ºåº”ç”¨ - Linux
      - name: æ„å»ºLinuxåº”ç”¨
        if: matrix.platform == 'linux'
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 45
          max_attempts: 3
          retry_wait_seconds: 60
          warning_on_retry: true
          command: npm run ${{ matrix.script }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEBUG: electron-builder
      
      # éªŒè¯æ„å»ºç»“æœ
      - name: éªŒè¯æ„å»ºç»“æœ
        shell: bash
        run: |
          echo "=== æ„å»ºç»“æœ ==="
          if [ -d "dist" ]; then
            ls -la dist/
            echo ""
            echo "=== æ–‡ä»¶å¤§å° ==="
            du -h dist/* 2>/dev/null || true
          else
            echo "âŒ distç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
      
      # ä¸Šä¼ æ„å»ºäº§ç‰©ä½œä¸ºå¤‡ä»½
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ${{ matrix.name }}-artifacts-${{ env.BUILD_VERSION }}
          path: |
            dist/*.exe
            dist/*.dmg
            dist/*.zip
            dist/*.deb
            dist/*.rpm
            dist/*.AppImage
            dist/*.yml
            dist/*.blockmap
            dist/latest*.yml
          retention-days: 30
          if-no-files-found: warn
      
      # æ„å»ºå¤±è´¥æ—¶çš„è¯Šæ–­ä¿¡æ¯
      - name: æ„å»ºå¤±è´¥è¯Šæ–­
        if: failure()
        shell: bash
        run: |
          echo "=== æ„å»ºå¤±è´¥è¯Šæ–­ ==="
          echo "Platform: ${{ matrix.platform }}"
          echo "OS: ${{ matrix.os }}"
          echo "Nodeç‰ˆæœ¬: $(node --version)"
          echo "npmç‰ˆæœ¬: $(npm --version)"
          echo ""
          echo "=== ç£ç›˜ç©ºé—´ ==="
          df -h || true
          echo ""
          echo "=== å†…å­˜ä½¿ç”¨ ==="
          free -h || true
          echo ""
          echo "=== ç¯å¢ƒå˜é‡ ==="
          env | grep -E "(ELECTRON|GH_|CSC_)" || true

  # å‘å¸ƒåå¤„ç†
  post-build:
    name: å‘å¸ƒåå¤„ç†
    needs: build
    runs-on: ubuntu-latest
    if: always() && (needs.build.result == 'success' || needs.build.result == 'partial')
    timeout-minutes: 15
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="${{ github.event.inputs.version || '1.0.0' }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "release_name=ğŸš€ My Awesome App v$VERSION" >> $GITHUB_OUTPUT
      
      - name: æ£€æŸ¥ReleaseçŠ¶æ€
        id: release_check
        continue-on-error: true
        run: |
          # æ£€æŸ¥Releaseæ˜¯å¦å­˜åœ¨
          RELEASE_ID=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ steps.version.outputs.tag }}" \
            | jq -r '.id // empty')
          
          if [ -n "$RELEASE_ID" ]; then
            echo "release_exists=true" >> $GITHUB_OUTPUT
            echo "release_id=$RELEASE_ID" >> $GITHUB_OUTPUT
            echo "âœ… Releaseå·²å­˜åœ¨: $RELEASE_ID"
          else
            echo "release_exists=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Releaseä¸å­˜åœ¨ï¼Œå°†åœ¨æ„å»ºè¿‡ç¨‹ä¸­åˆ›å»º"
          fi
      
      - name: åˆ›å»ºå‘å¸ƒè¯´æ˜
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## ğŸ‰ My Awesome App v${{ steps.version.outputs.version }}
          
          ### âœ¨ æ–°å¢åŠŸèƒ½
          - æ–°å¢åŠŸèƒ½ç‰¹æ€§æè¿°
          
          ### ğŸ› é—®é¢˜ä¿®å¤  
          - ä¿®å¤å·²çŸ¥é—®é¢˜
          
          ### ğŸ”§ æ”¹è¿›ä¼˜åŒ–
          - æ€§èƒ½ä¼˜åŒ–å’Œä½“éªŒæ”¹è¿›
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          
          **Windowsç”¨æˆ·:**
          - ğŸªŸ `My-Awesome-App-${{ steps.version.outputs.version }}-win-x64.exe` - NSISå®‰è£…ç¨‹åº
          - ğŸ“¦ `My-Awesome-App-${{ steps.version.outputs.version }}-portable-win-x64.exe` - ä¾¿æºç‰ˆæœ¬
          
          **macOSç”¨æˆ·:**
          - ğŸ `My-Awesome-App-${{ steps.version.outputs.version }}-mac-x64.dmg` - IntelèŠ¯ç‰‡Mac
          - ğŸ `My-Awesome-App-${{ steps.version.outputs.version }}-mac-arm64.dmg` - Apple Silicon Mac
          
          **Linuxç”¨æˆ·:**
          - ğŸ§ `My-Awesome-App-${{ steps.version.outputs.version }}-x86_64.AppImage` - é€šç”¨ç‰ˆæœ¬
          - ğŸ“¦ `my-awesome-app_${{ steps.version.outputs.version }}_amd64.deb` - Ubuntu/DebianåŒ…
          - ğŸ“¦ `my-awesome-app-${{ steps.version.outputs.version }}.x86_64.rpm` - CentOS/FedoraåŒ…
          
          ### ğŸ”„ è‡ªåŠ¨æ›´æ–°
          åº”ç”¨æ”¯æŒè‡ªåŠ¨æ›´æ–°ï¼Œå®‰è£…åä¼šè‡ªåŠ¨æ£€æµ‹æ–°ç‰ˆæœ¬ã€‚
          
          ### ğŸ” æ–‡ä»¶æ ¡éªŒ
          æ‰€æœ‰æ–‡ä»¶éƒ½åŒ…å«SHA256æ ¡éªŒå€¼ï¼Œç¡®ä¿ä¸‹è½½å®Œæ•´æ€§ã€‚
          
          ---
          
          **ğŸ“ å®Œæ•´æ›´æ–°æ—¥å¿—:** [æŸ¥çœ‹æ‰€æœ‰æ›´æ”¹](${{ github.server_url }}/${{ github.repository }}/compare/v${{ steps.version.outputs.version }}...main)
          
          **ğŸ› é—®é¢˜åé¦ˆ:** [æäº¤Issue](${{ github.server_url }}/${{ github.repository }}/issues/new)
          
          **â­ é¡¹ç›®åœ°å€:** [${{ github.repository }}](${{ github.server_url }}/${{ github.repository }})
          EOF
      
      - name: è·å–æ„å»ºç»Ÿè®¡
        id: build_stats
        run: |
          # ç»Ÿè®¡æ„å»ºç»“æœ
          SUCCESS_COUNT=0
          TOTAL_COUNT=0
          PLATFORMS=""
          
          # æ£€æŸ¥å„å¹³å°æ„å»ºçŠ¶æ€
          if [[ "${{ needs.build.result }}" == "success" ]]; then
            SUCCESS_COUNT=3
            TOTAL_COUNT=3
            PLATFORMS="Windows, macOS, Linux"
          else
            # è¿™é‡Œå¯ä»¥è¿›ä¸€æ­¥ç»†åŒ–ç»Ÿè®¡é€»è¾‘
            SUCCESS_COUNT=2
            TOTAL_COUNT=3
            PLATFORMS="éƒ¨åˆ†å¹³å°"
          fi
          
          echo "success_count=$SUCCESS_COUNT" >> $GITHUB_OUTPUT
          echo "total_count=$TOTAL_COUNT" >> $GITHUB_OUTPUT
          echo "platforms=$PLATFORMS" >> $GITHUB_OUTPUT
      
      - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
        run: |
          echo "ğŸ‰ æ„å»ºå’Œå‘å¸ƒå®Œæˆ!"
          echo "ğŸ“Š æ„å»ºç»Ÿè®¡:"
          echo "  - ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
          echo "  - æˆåŠŸå¹³å°: ${{ steps.build_stats.outputs.success_count }}/${{ steps.build_stats.outputs.total_count }}"
          echo "  - æ”¯æŒå¹³å°: ${{ steps.build_stats.outputs.platforms }}"
          echo ""
          echo "ğŸ”— ç›¸å…³é“¾æ¥:"
          echo "  - Releaseé¡µé¢: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"
          echo "  - Actionsé¡µé¢: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "ğŸ“± ç”¨æˆ·å¯ä»¥ä»Releaseé¡µé¢ä¸‹è½½å¯¹åº”å¹³å°çš„å®‰è£…åŒ…"
          echo "ğŸ”„ åº”ç”¨æ”¯æŒè‡ªåŠ¨æ›´æ–°åŠŸèƒ½"

  # æ¸…ç†ä»»åŠ¡
  cleanup:
    name: æ¸…ç†æ„å»ºç¼“å­˜
    needs: [build, post-build]
    runs-on: ubuntu-latest
    if: always()
    timeout-minutes: 10
    
    steps:
      - name: æ¸…ç†æ—§çš„å·¥ä»¶
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            Windows-artifacts-*
            macOS-artifacts-*
            Linux-artifacts-*
          useGlob: true
          failOnError: false
        continue-on-error: true
      
      - name: æ¸…ç†å®Œæˆ
        run: |
          echo "ğŸ§¹ æ¸…ç†ä»»åŠ¡å®Œæˆ"
          echo "ä¿ç•™å½“å‰ç‰ˆæœ¬çš„æ„å»ºå·¥ä»¶ï¼Œæ¸…ç†äº†å†å²ç‰ˆæœ¬"