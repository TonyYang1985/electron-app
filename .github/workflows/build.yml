name: æ„å»ºå’Œå‘å¸ƒ

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.5)'
        required: true
        default: '1.0.5'

# ä¿®æ­£æƒé™é…ç½® - ç§»é™¤æ— æ•ˆæƒé™
permissions:
  contents: write
  actions: read
  packages: write
  pull-requests: read
  security-events: read
  statuses: read

jobs:
  # æ„å»ºé˜¶æ®µ
  build:
    name: æ„å»º ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            name: Windows
            platform: win
          - os: macos-latest
            name: macOS
            platform: mac
          - os: ubuntu-latest
            name: Linux
            platform: linux
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: å®‰è£…ä¾èµ–
        run: npm ci
      
      # ä¿®æ­£TokenéªŒè¯
      - name: éªŒè¯GitHub Token
        shell: bash
        run: |
          if [ -n "$GH_TOKEN" ]; then
            echo "âœ… GH_TOKEN å·²è®¾ç½®"
            echo "Tokenå‰ç¼€: ${GH_TOKEN:0:10}..."
          else
            echo "âŒ GH_TOKEN æœªè®¾ç½®"
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      
      # Windowsæ„å»ºå¹¶å‘å¸ƒ
      - name: Windowsæ„å»ºå¹¶å‘å¸ƒ
        if: matrix.platform == 'win'
        shell: cmd
        run: |
          set CSC_IDENTITY_AUTO_DISCOVERY=false
          npm run publish:win
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      
      # macOSæ„å»ºå¹¶å‘å¸ƒ
      - name: macOSæ„å»ºå¹¶å‘å¸ƒ
        if: matrix.platform == 'mac'
        run: npm run publish:mac
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      
      # Linuxæ„å»ºå¹¶å‘å¸ƒ
      - name: Linuxæ„å»ºå¹¶å‘å¸ƒ
        if: matrix.platform == 'linux'
        run: npm run publish:linux
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      
      # éªŒè¯æ„å»ºç»“æœ
      - name: éªŒè¯æ„å»ºç»“æœ
        shell: bash
        run: |
          echo "=== æ„å»ºå®Œæˆ ==="
          if [ -d "dist" ]; then
            ls -la dist/
            echo "âœ… æ„å»ºæˆåŠŸ"
          else
            echo "âŒ æ„å»ºå¤±è´¥ï¼Œdistç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
      
      # ä¸Šä¼ æ„å»ºäº§ç‰©ä½œä¸ºå¤‡ä»½
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ${{ matrix.name }}-build-${{ github.run_number }}
          path: |
            dist/*.exe
            dist/*.dmg
            dist/*.zip
            dist/*.deb
            dist/*.rpm
            dist/*.AppImage
            dist/*.yml
            dist/*.blockmap
          retention-days: 30
          if-no-files-found: warn

  # å‘å¸ƒéªŒè¯é˜¶æ®µ
  verify-release:
    name: éªŒè¯å‘å¸ƒç»“æœ
    needs: build
    runs-on: ubuntu-latest
    if: needs.build.result == 'success'
    timeout-minutes: 15
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="${{ github.event.inputs.version || '1.0.5' }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "å‘å¸ƒç‰ˆæœ¬: $VERSION"
      
      # éªŒè¯Releaseæ˜¯å¦åˆ›å»ºæˆåŠŸ
      - name: éªŒè¯ReleaseçŠ¶æ€
        run: |
          echo "=== éªŒè¯Releaseåˆ›å»ºçŠ¶æ€ ==="
          
          # ç­‰å¾…Releaseå®Œå…¨åˆ›å»º
          sleep 30
          
          # æ£€æŸ¥Releaseæ˜¯å¦å­˜åœ¨
          response=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                          "https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ steps.version.outputs.tag }}")
          
          if echo "$response" | jq -e '.tag_name' > /dev/null; then
            echo "âœ… Releaseåˆ›å»ºæˆåŠŸ"
            release_name=$(echo "$response" | jq -r '.name')
            release_url=$(echo "$response" | jq -r '.html_url')
            
            echo "Releaseåç§°: $release_name"
            echo "Release URL: $release_url"
            
            # æ£€æŸ¥assetsæ•°é‡
            assets_count=$(echo "$response" | jq '.assets | length')
            echo "åŒ…å«æ–‡ä»¶æ•°é‡: $assets_count"
            
            if [ "$assets_count" -gt 0 ]; then
              echo ""
              echo "ğŸ“¦ Releaseæ–‡ä»¶åˆ—è¡¨:"
              echo "$response" | jq -r '.assets[] | "  - \(.name) (\((.size / 1024 / 1024 * 100 | floor) / 100)MB)"'
            else
              echo "âš ï¸ Releaseåˆ›å»ºæˆåŠŸä½†æ²¡æœ‰æ–‡ä»¶"
            fi
            
            # æ£€æŸ¥è‡ªåŠ¨æ›´æ–°é…ç½®æ–‡ä»¶
            echo ""
            echo "ğŸ” æ£€æŸ¥è‡ªåŠ¨æ›´æ–°é…ç½®:"
            if echo "$response" | jq -e '.assets[] | select(.name | test("latest.*\\.yml"))' > /dev/null; then
              echo "âœ… æ‰¾åˆ°è‡ªåŠ¨æ›´æ–°é…ç½®æ–‡ä»¶"
            else
              echo "âš ï¸ æœªæ‰¾åˆ°è‡ªåŠ¨æ›´æ–°é…ç½®æ–‡ä»¶"
            fi
            
          else
            echo "âŒ Releaseåˆ›å»ºå¤±è´¥æˆ–æœªæ‰¾åˆ°"
            echo "APIå“åº”: $response"
            exit 1
          fi
      
      # å‘å¸ƒæˆåŠŸé€šçŸ¥
      - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
        run: |
          echo ""
          echo "ğŸ‰ æ„å»ºå’Œå‘å¸ƒæµç¨‹å®Œæˆ!"
          echo ""
          echo "ğŸ“Š å‘å¸ƒä¿¡æ¯:"
          echo "  ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
          echo "  æ ‡ç­¾: ${{ steps.version.outputs.tag }}"
          echo ""
          echo "ğŸ”— ç›¸å…³é“¾æ¥:"
          echo "  Releaseé¡µé¢: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"
          echo "  Actionsé¡µé¢: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "ğŸ“± ç”¨æˆ·ç°åœ¨å¯ä»¥ä»Releaseé¡µé¢ä¸‹è½½å¯¹åº”å¹³å°çš„å®‰è£…åŒ…!"
          echo ""
          echo "ğŸ”„ è‡ªåŠ¨æ›´æ–°åŠŸèƒ½å·²é…ç½®ï¼Œç”¨æˆ·å®‰è£…åä¼šè‡ªåŠ¨æ£€æµ‹æ–°ç‰ˆæœ¬ã€‚"

  # æ¸…ç†å·¥ä»¶
  cleanup:
    name: æ¸…ç†æ„å»ºå·¥ä»¶
    needs: [build, verify-release]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: æ¸…ç†æ„å»ºå·¥ä»¶
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            Windows-build-${{ github.run_number }}
            macOS-build-${{ github.run_number }}
            Linux-build-${{ github.run_number }}
        continue-on-error: true
      
      - name: æ¸…ç†å®Œæˆ
        run: echo "ğŸ§¹ æ„å»ºå·¥ä»¶æ¸…ç†å®Œæˆ"