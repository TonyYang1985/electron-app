# Electron App 项目结构文档

## 项目概述

**My Awesome App** 是一个基于 Electron 28.0.0 和 TypeScript 构建的跨平台桌面应用程序，支持 Windows、macOS 和 Linux 平台。项目采用现代化的开发工具链，包含自动更新、多环境配置和 CI/CD 自动化构建发布流程。

## 技术栈

- **运行时**: Electron 28.0.0 + Node.js 20.x
- **开发语言**: TypeScript 5.9.2
- **构建工具**: electron-builder 26.0.12
- **包管理**: npm
- **CI/CD**: GitHub Actions
- **自动更新**: electron-updater 6.6.2

## 项目结构

```
electron-app/
├── .github/                    # GitHub Actions 工作流程
│   └── workflows/
│       └── build.yml          # 自动构建和发布工作流
├── .gitignore                 # Git 忽略文件配置
├── README.md                  # 项目说明文档
├── CHANGELOG.md               # 版本更新日志
├── package.json               # 项目配置和依赖管理
├── package-lock.json          # 依赖版本锁定文件
├── tsconfig.json              # TypeScript 编译配置
├── electron-builder.json      # Electron 构建配置
│
├── src/                       # 源代码目录
│   ├── main.ts               # Electron 主进程入口文件
│   ├── index.html            # 渲染进程 HTML 文件
│   ├── scripts/              # 构建脚本目录
│   │   └── start.ts          # 环境配置启动脚本
│   └── shared/               # 共享代码目录
│
├── assets/                    # 应用图标资源
│   ├── icon.ico              # Windows 图标
│   ├── icon.icns             # macOS 图标
│   ├── icon.png              # Linux 图标
│   ├── mol-*.ico             # 环境特定图标 (DEV/SIT/UAT/DEMO)
│   ├── mol-*.icns            # 环境特定 macOS 图标
│   └── splash.png            # 启动画面
│
├── build/                     # 构建资源目录
│   ├── icon.ico              # 构建用图标
│   ├── installer.nsi         # NSIS 安装器脚本
│   ├── installer.nsh         # NSIS 辅助脚本
│   ├── ntitlements.mac.plist # macOS 权限配置
│   └── LICENSE_*.md          # 多语言许可证文件
│
├── env/                       # 环境配置文件
│   ├── common.json           # 通用配置
│   ├── PROD.json             # 生产环境配置
│   ├── DEV.json              # 开发环境配置
│   ├── SIT.json              # 测试环境配置
│   ├── DEMO.json             # 演示环境配置
│   ├── meta.json             # 元数据配置
│   └── electron_builder_template.json # 构建模板
│
├── scripts/                   # 构建钩子脚本
│   ├── before-build.js       # 构建前处理
│   ├── after-pack.js         # 打包后处理
│   ├── after-all-artifact-build.js # 构建完成后处理
│   └── notarize.js           # macOS 公证脚本
│
├── docs/                      # 项目文档
├── release/                   # TypeScript 编译输出 (构建时生成)
├── dist/                      # 临时构建目录
└── node_modules/              # 依赖包目录
```

## 核心文件说明

### 配置文件

#### `package.json`

项目的核心配置文件，定义了应用信息、依赖关系和构建脚本。

**关键配置**:

- `main`: `"release/main.js"` - 指向编译后的主进程文件
- `version`: `"1.0.47"` - 当前应用版本
- `staticVersion`: `"1.7.16"` - 静态资源版本

**核心脚本**:

```json
{
  "scripts": {
    "start": "npm run build && electron .",
    "dev": "npm run build && electron . --dev",
    "build": "npm run compile && npm run copy",
    "compile": "tsc",
    "copy": "shx mkdir -p release && shx cp src/index.html release/index.html",
    "build:win": "npm run config:ts:PROD && npm run build && electron-builder --win",
    "build:mac": "npm run config:ts:PROD && npm run build && electron-builder --mac",
    "build:linux": "npm run config:ts:PROD && npm run build && electron-builder --linux"
  }
}
```

#### `tsconfig.json`

TypeScript 编译配置，将 `src/` 目录下的 TypeScript 代码编译到 `release/` 目录。

#### `electron-builder.json`

Electron 构建配置文件，定义了打包参数、输出目录、文件包含规则等。

**关键配置**:

- `appId`: `"com.emarineonline.mo"` - 应用唯一标识
- `productName`: `"BMO Middle Office"` - 应用显示名称
- `directories.output`: `"BMO-MO-APP-RELEASES/PROD"` - 构建输出目录

### 源代码文件

#### `src/main.ts`

Electron 主进程入口文件，负责：

- 创建和管理应用窗口
- 处理应用生命周期事件
- 集成自动更新功能
- 开发模式下启用开发者工具

**核心功能**:

```typescript
// 创建主窗口
function createWindow(): void {
  mainWindow = new BrowserWindow({
    width: 1200,
    height: 800,
    webPreferences: {
      nodeIntegration: true,
      contextIsolation: false
    }
  });
}

// 自动更新检查
autoUpdater.on('update-available', (info: UpdateInfo) => {
  // 显示更新提示对话框
});
```

#### `src/index.html`

渲染进程的 HTML 文件，定义应用的用户界面。

#### `src/scripts/start.ts`

环境配置启动脚本，根据 `API_ENV` 环境变量动态生成 `electron-builder.json` 配置。

### 环境配置

#### 多环境支持

项目支持 5 种环境配置：

| 环境 | 配置文件 | 用途 | 图标 |
|------|----------|------|------|
| PROD | `env/PROD.json` | 生产环境 | `mol.ico/icns` |
| DEV | `env/DEV.json` | 开发环境 | `mol-DEV.ico/icns` |
| SIT | `env/SIT.json` | 系统集成测试 | `mol-SIT.ico/icns` |
| UAT | `env/UAT.json` | 用户验收测试 | `mol-UAT.ico/icns` |
| DEMO | `env/DEMO.json` | 演示环境 | `mol-DEMO.ico/icns` |

#### 环境配置切换

通过 npm 脚本切换环境：

```bash
npm run config:ts:PROD    # 生产环境
npm run config:ts:DEV     # 开发环境
npm run config:ts:SIT     # 测试环境
npm run config:ts:DEMO    # 演示环境
```

### 构建钩子脚本

#### `scripts/before-build.js`

构建前执行的脚本，用于准备构建环境。

#### `scripts/after-pack.js`

打包完成后执行的脚本，用于后处理操作。

#### `scripts/notarize.js`

macOS 应用公证脚本，确保应用可以在 macOS 上正常运行。

## 本地开发流程

### 环境准备

```bash
# 1. 克隆项目
git clone https://github.com/TonyYang1985/electron-app.git
cd electron-app

# 2. 安装依赖
npm install

# 3. 安装 Electron (如果需要)
npm install electron --save-dev
```

### 开发模式运行

```bash
# 方法一：标准开发模式
npm run dev

# 方法二：分步执行
npm run build    # 编译 TypeScript + 复制资源
npm start        # 启动 Electron 应用
```

**开发模式特性**:

- 自动打开开发者工具
- 支持热重载（需要重新运行 `npm run dev`）
- 跳过自动更新检查

### 构建流程

#### 本地构建测试

```bash
# 编译代码
npm run compile  # 或 npx tsc

# 复制资源文件
npm run copy

# 完整构建
npm run build
```

#### 平台特定构建

```bash
# Windows 平台
npm run build:win

# macOS 平台  
npm run build:mac

# Linux 平台
npm run build:linux
```

### 调试和测试

#### TypeScript 编译检查

```bash
# 检查类型错误（不生成文件）
npx tsc --noEmit

# 监听模式编译
npx tsc --watch
```

#### Electron 调试

1. **主进程调试**:

   ```bash
   # 启用调试模式
   npm run dev
   # 在 Chrome 中访问 chrome://inspect
   ```

2. **渲染进程调试**:
   - 开发模式下自动打开开发者工具
   - 或按 `Ctrl+Shift+I` / `Cmd+Option+I`

### 环境配置开发

#### 修改环境配置

1. 编辑对应的环境配置文件（如 `env/DEV.json`）
2. 运行环境配置脚本：

   ```bash
   npm run config:ts:DEV
   ```

3. 重新构建应用：

   ```bash
   npm run build
   npm start
   ```

#### 添加新环境

1. 在 `env/` 目录创建新的配置文件
2. 在 `package.json` 中添加对应的配置脚本
3. 准备对应的图标资源

## 构建输出

### 开发构建

- `release/` - TypeScript 编译输出
  - `main.js` - 编译后的主进程文件
  - `index.html` - 复制的 HTML 文件

### 生产构建

根据平台不同，生成以下文件：

#### Windows

- `bmo-mo-app-1.0.46-win-x64.exe` - NSIS 安装程序
- `bmo-mo-app-1.0.46-win-x64.exe.blockmap` - 更新校验文件

#### macOS

- `bmo-mo-app-1.0.46-mac-x64.dmg` - Intel Mac 安装包
- `bmo-mo-app-1.0.46-mac-arm64.dmg` - Apple Silicon 安装包
- 对应的 `.blockmap` 文件

#### Linux

- `bmo-mo-app-1.0.46-linux-x64.AppImage` - 便携版
- `bmo-mo-app-1.0.46-linux-amd64.deb` - Debian 包
- `bmo-mo-app-1.0.46-linux-x86_64.rpm` - RPM 包

## 自动化工作流

### GitHub Actions

项目集成了完整的 CI/CD 流程（`.github/workflows/build.yml`）：

1. **触发条件**:
   - Git 标签推送 (`v*`)
   - 手动触发

2. **构建矩阵**:
   - Windows (windows-latest)
   - macOS (macos-latest)  
   - Linux (ubuntu-latest)

3. **环境解析**:
   - 从标签自动解析环境（如 `v1.0.47-dev`）
   - 支持 PROD/DEV/SIT/DEMO 四种环境

4. **自动发布**:
   - 构建成功后自动创建 GitHub Release
   - PROD 环境标记为 latest
   - 其他环境标记为 prerelease

### 发布流程

```bash
# 1. 更新版本号
npm version patch  # 或 minor/major

# 2. 创建环境标签
git tag v1.0.47-prod
git push origin v1.0.47-prod

# 3. GitHub Actions 自动构建和发布
```

## 故障排除

### 常见问题

#### 1. TypeScript 编译失败

```bash
# 检查语法错误
npx tsc --noEmit

# 清理并重新编译
npm run clean
npm run compile
```

#### 2. Electron 启动失败

- 检查 `package.json` 中的 `main` 字段是否正确
- 确认 `release/main.js` 文件存在
- 查看控制台错误信息

#### 3. 构建失败

- 检查 `electron-builder.json` 配置
- 确认所有依赖已正确安装
- 查看构建日志中的具体错误

#### 4. 环境配置不生效

- 确认运行了对应的配置脚本
- 检查 `electron-builder.json` 是否正确生成
- 重新构建应用

### 调试技巧

1. **启用详细日志**:

   ```bash
   DEBUG=electron-builder npm run build:win
   ```

2. **检查文件包含**:

   ```bash
   # 查看哪些文件会被打包
   npx electron-builder --dir
   ```

3. **本地测试构建**:

   ```bash
   # 只构建目录，不生成安装包
   npx electron-builder --dir --win
   ```

## 最佳实践

### 开发建议

1. **代码规范**:
   - 使用 TypeScript 严格模式
   - 遵循 ESLint 规则
   - 保持代码注释完整

2. **版本管理**:
   - 使用语义化版本号
   - 及时更新 CHANGELOG.md
   - 为每个版本创建对应标签

3. **环境管理**:
   - 不同环境使用不同配置
   - 敏感信息使用环境变量
   - 定期检查配置文件同步

4. **构建优化**:
   - 定期清理构建缓存
   - 优化文件包含规则
   - 监控构建产物大小

### 安全考虑

1. **代码签名**:
   - 生产环境启用代码签名
   - 妥善保管签名证书
   - 配置 macOS 公证

2. **依赖管理**:
   - 定期更新依赖版本
   - 使用 `npm audit` 检查安全漏洞
   - 锁定关键依赖版本

3. **发布安全**:
   - 使用 GitHub Secrets 管理敏感信息
   - 限制 GitHub Actions 权限
   - 验证发布产物完整性

---

## 相关链接

- [Electron 官方文档](https://www.electronjs.org/docs)
- [electron-builder 文档](https://www.electron.build/)
- [TypeScript 官方文档](https://www.typescriptlang.org/docs/)
- [GitHub Actions 文档](https://docs.github.com/en/actions)
