# GitHub Workflow 构建和发布文档

## 概述

这是一个完整的 GitHub Actions 工作流程，用于自动化构建和发布 Electron 应用程序。支持多平台构建（Windows、macOS、Linux）和多环境发布（PROD、DEV、SIT、DEMO）。

## 工作流程特性

### 🚀 核心功能

- **多平台构建**: Windows、macOS、Linux 同时构建
- **多环境支持**: PROD、DEV、SIT、DEMO 四种环境
- **智能环境解析**: 从 Git 标签自动解析环境
- **TypeScript 编译**: 自动编译 TypeScript 代码
- **自动发布**: 构建成功后自动创建 GitHub Release
- **工件管理**: 自动上传和清理构建产物

### 🎯 触发条件

1. **Git 标签推送**: `v*` 格式的标签（如 `v1.0.44-dev`）
2. **手动触发**: 通过 GitHub Actions 界面手动运行

## 环境配置

### 支持的环境类型

| 环境 | 标签后缀 | 描述 | 发布类型 |
|------|----------|------|----------|
| PROD | `-prod`, `-production` | 生产环境 | 正式发布 (latest) |
| DEV | `-dev`, `-development` | 开发环境 | 预发布版本 |
| SIT | `-sit`, `-staging` | 测试环境 | 预发布版本 |
| DEMO | `-demo`, `-demonstration` | 演示环境 | 预发布版本 |

### 标签格式示例

```bash
v1.0.44-prod    # 生产环境
v1.0.44-dev     # 开发环境
v1.0.44-sit     # 测试环境
v1.0.44-demo    # 演示环境
v1.0.44         # 默认为生产环境
```

## 构建矩阵

### 支持的平台

| 平台 | 运行环境 | 构建命令 | 输出格式 |
|------|----------|----------|----------|
| Windows | `windows-latest` | `npm run build:win` | `.exe`, `.blockmap` |
| macOS | `macos-latest` | `npm run build:mac` | `.dmg`, `.blockmap` |
| Linux | `ubuntu-latest` | `npm run build:linux` | `.AppImage`, `.deb`, `.rpm` |

## 工作流程步骤

### 1. 构建阶段 (build)

#### 环境解析

```yaml
- name: 解析环境信息
  id: parse_env
  # 从标签或手动输入解析构建环境
  # 支持大小写不敏感的环境后缀识别
```

#### TypeScript 编译

```yaml
- name: 编译和准备文件
  run: npm run build
  # 编译 TypeScript 代码到 release/ 目录
```

#### 构建验证

```yaml
- name: 验证构建结果
  # 检查 TypeScript 编译结果
  # 验证构建文件是否生成成功
```

#### Git 环境清理

```yaml
- name: 清理Git标签环境
  # 防止 electron-builder 自动发布
  # 移除所有标签和远程引用
```

#### 平台构建

```yaml
- name: 构建 ${{ matrix.name }}
  run: npm run build:${{ matrix.platform }}
  env:
    CSC_IDENTITY_AUTO_DISCOVERY: false
    BUILD_ENVIRONMENT: ${{ steps.parse_env.outputs.BUILD_ENVIRONMENT }}
```

### 2. 发布阶段 (release)

#### 文件整理

```yaml
- name: 整理发布文件
  # 收集所有平台的构建产物
  # 统计文件数量和大小
```

#### Release 创建

```yaml
- name: 创建GitHub Release
  uses: softprops/action-gh-release@v2
  # 根据环境类型决定是否为预发布版本
  # 生成详细的发布说明
```

### 3. 清理阶段 (cleanup)

```yaml
- name: 清理构建工件
  uses: geekyeggo/delete-artifact@v5
  # 自动清理临时构建工件
```

## 使用方法

### 方法一: Git 标签触发

```bash
# 创建并推送标签
git tag v1.0.44-dev
git push origin v1.0.44-dev

# 或者一次性创建多环境标签
git tag v1.0.44-dev
git tag v1.0.44-sit  
git tag v1.0.44-demo
git tag v1.0.44-prod
git push origin --tags
```

### 方法二: 手动触发

1. 进入 GitHub 仓库的 **Actions** 页面
2. 选择 **构建和发布** 工作流程
3. 点击 **Run workflow**
4. 填写参数：
   - **版本号**: 如 `1.0.44`
   - **构建环境**: 选择 PROD/DEV/SIT/DEMO

## 输出产物

### Windows 平台

- `my-awesome-app-*-win-x64.exe` - NSIS 安装程序
- `my-awesome-app-*-win-x64.exe.blockmap` - 校验文件

### macOS 平台

- `my-awesome-app-*-mac-x64.dmg` - Intel Mac 安装包
- `my-awesome-app-*-mac-arm64.dmg` - Apple Silicon 安装包
- 对应的 `.blockmap` 校验文件

### Linux 平台

- `my-awesome-app-*-linux-x64.AppImage` - 通用便携版
- `my-awesome-app-*-linux-amd64.deb` - Debian/Ubuntu 包
- `my-awesome-app-*-linux-x86_64.rpm` - CentOS/Fedora 包

## 环境变量

### 必需的 Secrets

- `GITHUB_TOKEN` - GitHub 自动提供，用于创建 Release

### 构建环境变量

- `BUILD_ENVIRONMENT` - 当前构建环境 (PROD/DEV/SIT/DEMO)
- `CSC_IDENTITY_AUTO_DISCOVERY` - 禁用代码签名自动发现

## 故障排除

### 常见问题

#### 1. TypeScript 编译失败

```bash
# 检查编译错误
npm run build
# 或者
npx tsc --noEmit
```

#### 2. 构建文件未找到

- 检查 `electron-builder.json` 配置
- 确认输出目录设置正确
- 验证 `package.json` 中的构建脚本

#### 3. Git 标签环境解析失败

- 确保标签格式正确: `v{version}-{env}`
- 环境后缀必须是: dev, sit, demo, prod
- 支持大小写不敏感

#### 4. Release 创建失败

- 检查 `GITHUB_TOKEN` 权限
- 确认仓库有 `contents: write` 权限
- 验证标签是否已存在

### 调试步骤

1. **检查工作流程日志**
   ```
   GitHub → Actions → 选择失败的运行 → 查看详细日志
   ```

2. **本地验证构建**
   ```bash
   npm ci
   npm run build
   npm run build:win  # 或 build:mac, build:linux
   ```

3. **验证环境配置**
   ```bash
   # 检查环境文件
   ls -la env/
   cat env/PROD.json  # 或其他环境文件
   ```

## 配置文件依赖

### 必需的配置文件

- `package.json` - 项目配置和构建脚本
- `electron-builder.json` - Electron 构建配置
- `tsconfig.json` - TypeScript 编译配置
- `env/*.json` - 环境配置文件

### 推荐的 package.json 脚本

```json
{
  "scripts": {
    "build": "npm run build:ts && npm run copy:assets",
    "build:ts": "tsc",
    "build:win": "electron-builder --win",
    "build:mac": "electron-builder --mac", 
    "build:linux": "electron-builder --linux",
    "build:all": "electron-builder --win --mac --linux"
  }
}
```

## 最佳实践

### 1. 版本管理

- 使用语义化版本号 (Semantic Versioning)
- 为不同环境使用不同的标签后缀
- 保持版本号的一致性

### 2. 环境隔离

- 每个环境使用独立的配置文件
- 构建产物按环境分别存储
- 发布策略按环境区分

### 3. 安全考虑

- 不要在代码中硬编码敏感信息
- 使用 GitHub Secrets 管理敏感配置
- 定期更新依赖项和 Actions 版本

### 4. 性能优化

- 使用 npm cache 加速依赖安装
- 并行构建多个平台
- 及时清理临时文件

## 更新和维护

### 定期维护任务

1. 更新 GitHub Actions 版本
2. 更新 Node.js 和 Electron 版本
3. 检查和更新依赖项
4. 测试各平台构建结果

### 版本升级指南

1. 更新 `package.json` 中的版本号
2. 更新相关配置文件
3. 测试本地构建
4. 创建对应的 Git 标签
5. 验证自动化构建和发布

---

## 联系和支持

如有问题或建议，请通过以下方式联系：
- 创建 GitHub Issue
- 查看项目文档
- 参考 GitHub Actions 官方文档
